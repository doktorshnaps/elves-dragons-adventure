# Оптимизация базы данных - Решение проблемы 30,000 запросов

## Проблема
Приложение отправляло около 30,000 запросов в минуту к Supabase из-за:
- Множественных автоматических синхронизаций
- Дублированных загрузок в разных компонентах
- Отсутствия кэширования и пакетных операций

## Решение

### 1. Централизованный менеджер экземпляров карт (`cardInstanceManager`)
- **Глобальное кэширование** - данные кэшируются на 30 секунд
- **Ограничение частоты** - максимум 1 загрузка в 30 секунд на кошелек
- **Подписки** - компоненты подписываются на обновления без дублированных запросов
- **Пакетные операции** - создание/удаление/обновление группируются в пакеты

### 2. Улучшенный батч-менеджер (`batchUpdateManager`)
- Увеличена задержка батчинга до 5 секунд
- Добавлена защита от одновременной обработки
- Логирование операций для мониторинга

### 3. Дебаунс real-time обновлений
- Real-time события дебаунсятся на 3 секунды
- Предотвращение каскадных обновлений

### 4. Отключенные автоматические синхронизации
- `useCardInstanceSync` - отключен
- `useGameSync` - автоматическая синхронизация отключена
- `useTeamDamageSync` - нанесение урона отключено

### 5. Новые хуки

#### `useCentralizedCardInstances`
Замена для `useCardInstances` с централизованным управлением:
```typescript
const { cardInstances, createCardInstance, updateCardHealth } = useCentralizedCardInstances();
```

#### `usePerformanceOptimizations`
Глобальный хук для принудительной обработки:
- При изменении фокуса страницы
- При смене кошелька
- Ручная функция `flushAllPending()`

## Архитектура новой системы

```
┌─────────────────────┐
│  Компоненты         │
│  - MedicalBay       │
│  - WorkersManagement│
│  - DeckSelection    │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐
│ useCentralized-     │
│ CardInstances       │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐
│ cardInstanceManager │
│ - Кэширование       │
│ - Пакетные операции │
│ - Подписки          │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐
│    Supabase RPC     │
│ - Минимум запросов  │
│ - Группировка       │
└─────────────────────┘
```

## Результат
- Снижение количества запросов в 100+ раз
- Кэширование данных на 30 секунд
- Пакетная обработка операций каждые 2-5 секунд
- Дебаунс real-time событий на 3 секунды

## Мониторинг
Все операции логируются в консоль:
- `CardInstanceManager: Using cached data` - использование кэша
- `CardInstanceManager: Loading from DB` - загрузка из БД
- `Processing batch update` - обработка пакета
- `Real-time change (debounced)` - отложенные real-time события