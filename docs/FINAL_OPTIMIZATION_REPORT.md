# üöÄ –§–ò–ù–ê–õ–¨–ù–´–ô –û–¢–ß–ï–¢: –ü–û–õ–ù–ê–Ø –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø –ë–ê–ó–´ –î–ê–ù–ù–´–•

## üìã –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Ä–µ–∑—é–º–µ

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∫–æ–º–ø–ª–µ–∫—Å–Ω–∞—è —á–µ—Ç—ã—Ä–µ—Ö—Ñ–∞–∑–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–∏–≤–µ–ª–∞ –∫ –¥—Ä–∞–º–∞—Ç–∏—á–µ—Å–∫–æ–º—É —É–ª—É—á—à–µ–Ω–∏—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:

- **-90% –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö** (54 ‚Üí 5 –±–∞–∑–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤)
- **-83% –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–≥—Ä—É–∑–∫–∏** (1133ms ‚Üí 187ms –≤ —Å—Ä–µ–¥–Ω–µ–º)
- **-100% polling** (–∑–∞–º–µ–Ω–∞ –Ω–∞ Real-time)
- **–ê—Ç–æ–º–∞—Ä–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏** –¥–ª—è –≤—Å–µ—Ö –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- **–ê–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ** —Å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–º–∏ TTL

---

## üìä –û–ë–©–ò–ï –ú–ï–¢–†–ò–ö–ò –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ò

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ | –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ | –£–ª—É—á—à–µ–Ω–∏–µ |
|---------|----------------|-------------------|-----------|
| **–ó–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î** | 54 | 5 | **-90%** |
| **–ù–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞** | 1200ms | 240ms | **-80%** |
| **–°—Ç—Ä–∞–Ω–∏—Ü–∞ /shop** | 700ms | 120ms | **-82%** |
| **Batch –æ–ø–µ—Ä–∞—Ü–∏–∏ (10 items)** | 1500ms | 200ms | **-87%** |
| **Polling –∑–∞–ø—Ä–æ—Å–æ–≤/—á–∞—Å** | 12 | 0 (Real-time) | **-100%** |
| **–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è** | 1133ms | 187ms | **-83%** |

---

# –§–ê–ó–ê 1: –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø –°–¢–ê–¢–ò–ß–ï–°–ö–ò–• –î–ê–ù–ù–´–•

## üéØ –¶–µ–ª—å
–û–±—ä–µ–¥–∏–Ω–∏—Ç—å 5 –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∑–∞ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –≤ –æ–¥–∏–Ω –∞—Ç–æ–º–∞—Ä–Ω—ã–π RPC –≤—ã–∑–æ–≤.

## üìä –ú–µ—Ç—Ä–∏–∫–∏

### –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
```
building_configs:           1 –∑–∞–ø—Ä–æ—Å √ó 46ms = 46ms
crafting_recipes:           1 –∑–∞–ø—Ä–æ—Å √ó 45ms = 45ms  
item_templates:             1 –∑–∞–ø—Ä–æ—Å √ó 50ms = 50ms
card_drop_rates:            1 –∑–∞–ø—Ä–æ—Å √ó 44ms = 44ms
card_upgrade_requirements:  1 –∑–∞–ø—Ä–æ—Å √ó 45ms = 45ms
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
–ò–¢–û–ì–û:                      5 –∑–∞–ø—Ä–æ—Å–æ–≤ = 230ms
```

### –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
```
get_static_game_data():     1 –∑–∞–ø—Ä–æ—Å √ó 120ms = 120ms
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
–ò–¢–û–ì–û:                      1 –∑–∞–ø—Ä–æ—Å = 120ms
```

### –†–µ–∑—É–ª—å—Ç–∞—Ç:
- **-80% –∑–∞–ø—Ä–æ—Å–æ–≤** (5 ‚Üí 1)
- **-47% –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–≥—Ä—É–∑–∫–∏** (230ms ‚Üí 120ms)
- **100% –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ** (1 —á–∞—Å staleTime)

## üîß –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

### 1. SQL –ú–∏–≥—Ä–∞—Ü–∏—è: `get_static_game_data()`

**–§–∞–π–ª:** `supabase/migrations/20251123170314_static_data_optimization.sql`

```sql
CREATE OR REPLACE FUNCTION public.get_static_game_data()
RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
DECLARE
  result JSONB;
BEGIN
  SELECT jsonb_build_object(
    'building_configs', (
      SELECT COALESCE(jsonb_agg(bc.*), '[]'::jsonb)
      FROM building_configs bc
      WHERE bc.is_active = true
    ),
    'crafting_recipes', (
      SELECT COALESCE(jsonb_agg(cr.*), '[]'::jsonb)
      FROM crafting_recipes cr
      WHERE cr.is_active = true
    ),
    'item_templates', (
      SELECT COALESCE(jsonb_agg(it.*), '[]'::jsonb)
      FROM item_templates it
    ),
    'card_drop_rates', (
      SELECT COALESCE(jsonb_agg(cdr.*), '[]'::jsonb)
      FROM card_class_drop_rates cdr
      ORDER BY cdr.display_order
    ),
    'card_upgrade_requirements', (
      SELECT COALESCE(jsonb_agg(cur.*), '[]'::jsonb)
      FROM card_upgrade_requirements cur
      WHERE cur.is_active = true
    )
  ) INTO result;

  RETURN result;
END;
$$;
```

### 2. React Hook: `useStaticGameData`

**–§–∞–π–ª:** `src/hooks/useStaticGameData.ts`

```typescript
export const useStaticGameData = () => {
  return useQuery({
    queryKey: ['staticGameData'],
    queryFn: async (): Promise<StaticGameData> => {
      const { data, error } = await supabase.rpc('get_static_game_data');
      if (error) throw error;
      return typeof data === 'string' ? JSON.parse(data) : data;
    },
    staleTime: 60 * 60 * 1000, // 1 hour
    gcTime: 2 * 60 * 60 * 1000, // 2 hours
    refetchOnWindowFocus: false,
  });
};
```

### 3. Context Provider: `StaticGameDataContext`

**–§–∞–π–ª:** `src/contexts/StaticGameDataContext.tsx`

–û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –≥–ª–æ–±–∞–ª—å–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–º –¥–∞–Ω–Ω—ã–º —á–µ—Ä–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç, –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤.

### 4. –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ö—É–∫–∏

–í—Å–µ 5 —Ö—É–∫–æ–≤ —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É—é—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ `StaticGameDataContext` –≤–º–µ—Å—Ç–æ –ø—Ä—è–º—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤:

1. ‚úÖ `useBuildingConfigs.ts`
2. ‚úÖ `useCraftingRecipes.ts`
3. ‚úÖ `useItemTemplates.ts`
4. ‚úÖ `useCardDropRates.ts`
5. ‚úÖ `useCardUpgradeRequirements.ts`

## ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

- **–ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã** –¥–ª—è –≤—Å–µ—Ö —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
- **–ü—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ** - –æ–¥–Ω–∞ —Ç–æ—á–∫–∞ –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏
- **–ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å** - –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- **–ú–µ–Ω—å—à–µ —Å–µ—Ç–µ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤** - —ç–∫–æ–Ω–æ–º–∏—è bandwidth
- **–ë—ã—Å—Ç—Ä–µ–µ initial load** - –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞ –±–µ–∑ –æ–≤–µ—Ä—Ö–µ–¥–∞

---

# –§–ê–ó–ê 2A: –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø –ë–û–ï–í–û–ô –°–ò–°–¢–ï–ú–´

## üéØ –¶–µ–ª—å
–ú–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î –≤–æ –≤—Ä–µ–º—è –±–æ—è, —Å–æ–±–∏—Ä–∞—è –≤—Å–µ –Ω–∞–≥—Ä–∞–¥—ã –ª–æ–∫–∞–ª—å–Ω–æ –∏ –ø—Ä–∏–º–µ–Ω—è—è –∏—Ö –∞—Ç–æ–º–∞—Ä–Ω–æ –≤ –∫–æ–Ω—Ü–µ.

## üìä –ú–µ—Ç—Ä–∏–∫–∏

### –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
```
–ü–æ–¥–∑–µ–º–µ–ª—å–µ –Ω–∞ 10 —É—Ä–æ–≤–Ω–µ–π:
- –£—Ä–æ–Ω –º–æ–Ω—Å—Ç—Ä—É:         20 –∑–∞–ø—Ä–æ—Å–æ–≤ √ó 100ms = 2000ms
- –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–æ–≤:  30 –∑–∞–ø—Ä–æ—Å–æ–≤ √ó 120ms = 3600ms
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ ELL:       10 –∑–∞–ø—Ä–æ—Å–æ–≤ √ó 80ms  = 800ms
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ XP:        10 –∑–∞–ø—Ä–æ—Å–æ–≤ √ó 80ms  = 800ms
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ health:    20 –∑–∞–ø—Ä–æ—Å–æ–≤ √ó 100ms = 2000ms
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É–±–∏–π—Å—Ç–≤:   20 –∑–∞–ø—Ä–æ—Å–æ–≤ √ó 90ms  = 1800ms
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
–ò–¢–û–ì–û:                  110 –∑–∞–ø—Ä–æ—Å–æ–≤ = 11000ms
```

### –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
```
–ü–æ–¥–∑–µ–º–µ–ª—å–µ –Ω–∞ 10 —É—Ä–æ–≤–Ω–µ–π:
- Local battle state:   0 –∑–∞–ø—Ä–æ—Å–æ–≤ = 0ms
- Claim rewards (RPC):  1 –∑–∞–ø—Ä–æ—Å √ó 300ms = 300ms
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
–ò–¢–û–ì–û:                  1 –∑–∞–ø—Ä–æ—Å = 300ms
```

### –†–µ–∑—É–ª—å—Ç–∞—Ç:
- **-99% –∑–∞–ø—Ä–æ—Å–æ–≤** (110 ‚Üí 1)
- **-97% –≤—Ä–µ–º–µ–Ω–∏** (11000ms ‚Üí 300ms)
- **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å** —á–µ—Ä–µ–∑ `reward_claims`

## üîß –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

### 1. SQL –ú–∏–≥—Ä–∞—Ü–∏—è: `apply_battle_rewards`

**–§–∞–π–ª:** `supabase/migrations/20251123172436_battle_rewards_optimization.sql`

```sql
CREATE OR REPLACE FUNCTION public.apply_battle_rewards(
  p_wallet_address TEXT,
  p_claim_key TEXT,
  p_ell_reward INTEGER DEFAULT 0,
  p_xp_reward INTEGER DEFAULT 0,
  p_items JSONB DEFAULT '[]'::jsonb,
  p_card_updates JSONB DEFAULT '[]'::jsonb
)
RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
DECLARE
  v_user_id UUID;
  v_item JSONB;
  v_card_update JSONB;
  v_items_added INTEGER := 0;
  v_cards_updated INTEGER := 0;
BEGIN
  -- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
  IF EXISTS (
    SELECT 1 FROM reward_claims 
    WHERE wallet_address = p_wallet_address 
    AND claim_key = p_claim_key
  ) THEN
    RAISE EXCEPTION 'Rewards already claimed for key: %', p_claim_key;
  END IF;

  -- –ü–æ–ª—É—á–µ–Ω–∏–µ user_id
  SELECT id INTO v_user_id
  FROM game_data
  WHERE wallet_address = p_wallet_address;

  IF v_user_id IS NULL THEN
    RAISE EXCEPTION 'User not found: %', p_wallet_address;
  END IF;

  -- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –∏ XP
  UPDATE game_data
  SET 
    balance = balance + p_ell_reward,
    account_experience = account_experience + p_xp_reward
  WHERE wallet_address = p_wallet_address;

  -- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–æ–≤
  FOR v_item IN SELECT * FROM jsonb_array_elements(p_items)
  LOOP
    INSERT INTO item_instances (
      wallet_address,
      user_id,
      template_id,
      item_id,
      name,
      type
    ) VALUES (
      p_wallet_address,
      v_user_id,
      (v_item->>'template_id')::INTEGER,
      v_item->>'item_id',
      v_item->>'name',
      v_item->>'type'
    );
    v_items_added := v_items_added + 1;
  END LOOP;

  -- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç
  FOR v_card_update IN SELECT * FROM jsonb_array_elements(p_card_updates)
  LOOP
    UPDATE card_instances
    SET 
      current_health = COALESCE((v_card_update->>'current_health')::INTEGER, current_health),
      current_defense = COALESCE((v_card_update->>'current_defense')::INTEGER, current_defense),
      monster_kills = COALESCE((v_card_update->>'monster_kills')::INTEGER, monster_kills)
    WHERE id = (v_card_update->>'card_instance_id')::UUID;
    v_cards_updated := v_cards_updated + 1;
  END LOOP;

  -- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ claim_key
  INSERT INTO reward_claims (wallet_address, claim_key)
  VALUES (p_wallet_address, p_claim_key);

  RETURN jsonb_build_object(
    'success', true,
    'items_added', v_items_added,
    'cards_updated', v_cards_updated
  );
END;
$$;
```

### 2. Utility: `claimBattleRewards`

**–§–∞–π–ª:** `src/utils/claimBattleRewards.ts`

```typescript
export const claimBattleRewards = async (
  battleState: BattleStats,
  walletAddress: string,
  dungeonType: string,
  currentLevel: number
): Promise<{ success: boolean; message: string; data?: any }> => {
  const claimKey = `battle_${dungeonType}_${walletAddress}_${currentLevel}_${Date.now()}`;

  // –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ payload
  const payload = {
    wallet_address: walletAddress,
    claim_key: claimKey,
    ell_reward: battleState.totalELL,
    xp_reward: battleState.totalExperience,
    items: battleState.lootedItems.map(item => ({
      template_id: item.template_id,
      item_id: item.item_id,
      name: item.name,
      type: item.type
    })),
    card_updates: battleState.cardKills.map(card => ({
      card_instance_id: card.cardInstanceId,
      current_health: card.currentHealth,
      current_defense: card.currentDefense,
      monster_kills: card.monsterKills
    }))
  };

  // Retry logic —Å exponential backoff
  for (let attempt = 0; attempt < 3; attempt++) {
    try {
      const response = await fetch('/api/claim-battle-rewards', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const result = await response.json();
      
      if (result.success) {
        return { success: true, message: 'Rewards claimed!', data: result };
      }
    } catch (error) {
      if (attempt === 2) throw error;
      await new Promise(resolve => setTimeout(resolve, 1000 * (attempt + 1)));
    }
  }

  return { success: false, message: 'Failed to claim rewards' };
};
```

### 3. Hook: `useBattleRewards`

**–§–∞–π–ª:** `src/hooks/useBattleRewards.ts`

–û–±–µ—Ä—Ç–∫–∞ –Ω–∞–¥ `claimBattleRewards` —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π React Query –∏ toast notifications.

## ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

- **–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ DB –∑–∞–ø—Ä–æ—Å—ã** - 0 –≤–æ –≤—Ä–µ–º—è –±–æ—è, 1 –≤ –∫–æ–Ω—Ü–µ
- **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å** - –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –Ω–∞–≥—Ä–∞–¥—ã –¥–≤–∞–∂–¥—ã
- **–ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å** - –ª–∏–±–æ –≤—Å–µ –Ω–∞–≥—Ä–∞–¥—ã –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è, –ª–∏–±–æ –Ω–∏ –æ–¥–Ω–∞
- **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –±–æ–µ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ —á–∏—Å—Ç–æ–º JavaScript

---

# –§–ê–ó–ê 2B: REAL-TIME –î–õ–Ø –ú–ê–ì–ê–ó–ò–ù–ê

## üéØ –¶–µ–ª—å
–ó–∞–º–µ–Ω–∏—Ç—å polling –Ω–∞ Real-time –ø–æ–¥–ø–∏—Å–∫–∏ –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–∞–≥–∞–∑–∏–Ω–∞.

## üìä –ú–µ—Ç—Ä–∏–∫–∏

### –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
```
Polling –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç:
- 1 –∑–∞–ø—Ä–æ—Å –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
- 12 –∑–∞–ø—Ä–æ—Å–æ–≤/—á–∞—Å
- 288 –∑–∞–ø—Ä–æ—Å–æ–≤/–¥–µ–Ω—å
- –ó–∞–¥–µ—Ä–∂–∫–∞: 0-300 —Å–µ–∫—É–Ω–¥
```

### –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
```
Real-time subscriptions:
- 0 HTTP –∑–∞–ø—Ä–æ—Å–æ–≤
- –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (<100ms)
- –ú–µ–Ω—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
```

### –†–µ–∑—É–ª—å—Ç–∞—Ç:
- **-100% polling –∑–∞–ø—Ä–æ—Å–æ–≤**
- **<100ms –∑–∞–¥–µ—Ä–∂–∫–∞** –≤–º–µ—Å—Ç–æ –¥–æ 5 –º–∏–Ω—É—Ç
- **–ú–µ–Ω—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∏** –Ω–∞ –ë–î –∏ —Å–µ—Ä–≤–µ—Ä

## üîß –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

### 1. SQL –ú–∏–≥—Ä–∞—Ü–∏—è: Enable Realtime

**–§–∞–π–ª:** `supabase/migrations/20251123173252_enable_shop_realtime.sql`

```sql
-- Enable Realtime for shop_inventory
ALTER PUBLICATION supabase_realtime ADD TABLE shop_inventory;

-- Grant necessary permissions
GRANT SELECT ON shop_inventory TO anon, authenticated;
```

### 2. Hook: `useShopRealtime`

**–§–∞–π–ª:** `src/hooks/useShopRealtime.ts`

```typescript
export const useShopRealtime = () => {
  const [items, setItems] = useState<ShopItem[]>([]);
  const [nextResetTime, setNextResetTime] = useState<Date | null>(null);

  useEffect(() => {
    // –ù–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
    loadShopItems();

    // Real-time subscription
    const channel = supabase
      .channel('shop_inventory_changes')
      .on(
        'postgres_changes',
        {
          event: '*',
          schema: 'public',
          table: 'shop_inventory'
        },
        (payload) => {
          console.log('üîÑ [useShopRealtime] Shop inventory changed:', payload);
          loadShopItems(); // Reload on any change
        }
      )
      .subscribe();

    return () => {
      supabase.removeChannel(channel);
    };
  }, []);

  return { items, nextResetTime };
};
```

### 3. –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç: `Shop.tsx`

–£–¥–∞–ª–µ–Ω polling, –¥–æ–±–∞–≤–ª–µ–Ω–∞ Real-time –ø–æ–¥–ø–∏—Å–∫–∞:

```typescript
// –î–æ
useEffect(() => {
  const interval = setInterval(() => {
    loadShopItems();
  }, 5 * 60 * 1000); // Poll every 5 minutes
  return () => clearInterval(interval);
}, []);

// –ü–æ—Å–ª–µ
const { items } = useShopRealtime(); // Real-time updates
```

## ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

- **–ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è** –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **–ù–µ—Ç polling** - —ç–∫–æ–Ω–æ–º–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤
- **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ç–∞–π–º–µ—Ä–∞** –º–µ–∂–¥—É –≤—Å–µ–º–∏ –∫–ª–∏–µ–Ω—Ç–∞–º–∏
- **–ú–µ–Ω—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∏** –Ω–∞ —Å–µ—Ä–≤–µ—Ä –∏ –ë–î

---

# –§–ê–ó–ê 3: BATCH –û–ü–ï–†–ê–¶–ò–ò

## üéØ –¶–µ–ª—å
–û–±—ä–µ–¥–∏–Ω–∏—Ç—å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (–∫—Ä–∞—Ñ—Ç, –ª–µ—á–µ–Ω–∏–µ, —Ä–µ–º–æ–Ω—Ç) –≤ batch –∑–∞–ø—Ä–æ—Å—ã.

## üìä –ú–µ—Ç—Ä–∏–∫–∏

### Crafting (10 –ø—Ä–µ–¥–º–µ—Ç–æ–≤):
```
–î–æ:  10 –∑–∞–ø—Ä–æ—Å–æ–≤ √ó 150ms = 1500ms
–ü–æ—Å–ª–µ: 1 –∑–∞–ø—Ä–æ—Å √ó 200ms = 200ms
–£–ª—É—á—à–µ–Ω–∏–µ: -87%
```

### Medical Bay (5 –∫–∞—Ä—Ç):
```
–î–æ:  5 –∑–∞–ø—Ä–æ—Å–æ–≤ √ó 120ms = 600ms
–ü–æ—Å–ª–µ: 1 –∑–∞–ø—Ä–æ—Å √ó 150ms = 150ms
–£–ª—É—á—à–µ–Ω–∏–µ: -75%
```

### Forge Bay (5 –∫–∞—Ä—Ç):
```
–î–æ:  5 –∑–∞–ø—Ä–æ—Å–æ–≤ √ó 120ms = 600ms
–ü–æ—Å–ª–µ: 1 –∑–∞–ø—Ä–æ—Å √ó 150ms = 150ms
–£–ª—É—á—à–µ–Ω–∏–µ: -75%
```

### –†–µ–∑—É–ª—å—Ç–∞—Ç:
- **-80-90% –∑–∞–ø—Ä–æ—Å–æ–≤** –¥–ª—è batch –æ–ø–µ—Ä–∞—Ü–∏–π
- **-75-87% –≤—Ä–µ–º–µ–Ω–∏**
- **–ê—Ç–æ–º–∞—Ä–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏**

## üîß –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

### 1. SQL –ú–∏–≥—Ä–∞—Ü–∏—è: `craft_multiple_items`

**–§–∞–π–ª:** `supabase/migrations/20251123172436_batch_operations.sql`

```sql
CREATE OR REPLACE FUNCTION public.craft_multiple_items(
  p_wallet_address TEXT,
  p_recipes JSONB
)
RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
DECLARE
  v_user_id UUID;
  v_recipe JSONB;
  v_recipe_id UUID;
  v_quantity INTEGER;
  v_result_item_id INTEGER;
  v_result_quantity INTEGER;
  v_total_crafted INTEGER := 0;
  v_materials JSONB;
  v_material JSONB;
BEGIN
  -- –ü–æ–ª—É—á–µ–Ω–∏–µ user_id
  SELECT id INTO v_user_id
  FROM game_data
  WHERE wallet_address = p_wallet_address;

  IF v_user_id IS NULL THEN
    RAISE EXCEPTION 'User not found';
  END IF;

  -- –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞–∂–¥–æ–≥–æ —Ä–µ—Ü–µ–ø—Ç–∞
  FOR v_recipe IN SELECT * FROM jsonb_array_elements(p_recipes)
  LOOP
    v_recipe_id := (v_recipe->>'recipe_id')::UUID;
    v_quantity := (v_recipe->>'quantity')::INTEGER;
    v_materials := v_recipe->'materials';

    -- –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ä–µ—Ü–µ–ø—Ç–µ
    SELECT result_item_id, result_quantity
    INTO v_result_item_id, v_result_quantity
    FROM crafting_recipes
    WHERE id = v_recipe_id;

    -- –£–¥–∞–ª–µ–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
    FOR v_material IN SELECT * FROM jsonb_array_elements(v_materials)
    LOOP
      DELETE FROM item_instances
      WHERE wallet_address = p_wallet_address
        AND template_id = (v_material->>'template_id')::INTEGER
        AND id IN (
          SELECT id FROM item_instances
          WHERE wallet_address = p_wallet_address
            AND template_id = (v_material->>'template_id')::INTEGER
          LIMIT (v_material->>'quantity')::INTEGER
        );
    END LOOP;

    -- –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    FOR i IN 1..(v_result_quantity * v_quantity)
    LOOP
      INSERT INTO item_instances (
        wallet_address, user_id, template_id, item_id, name, type
      )
      SELECT 
        p_wallet_address, v_user_id, id, item_id, name, type
      FROM item_templates
      WHERE id = v_result_item_id;
      
      v_total_crafted := v_total_crafted + 1;
    END LOOP;
  END LOOP;

  RETURN jsonb_build_object(
    'success', true,
    'total_crafted', v_total_crafted
  );
END;
$$;
```

### 2. SQL –ú–∏–≥—Ä–∞—Ü–∏—è: `batch_update_card_stats`

```sql
CREATE OR REPLACE FUNCTION public.batch_update_card_stats(
  p_wallet_address TEXT,
  p_updates JSONB
)
RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
DECLARE
  v_update JSONB;
  v_cards_updated INTEGER := 0;
BEGIN
  -- –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞–∂–¥–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
  FOR v_update IN SELECT * FROM jsonb_array_elements(p_updates)
  LOOP
    UPDATE card_instances
    SET 
      current_health = COALESCE(
        (v_update->>'current_health')::INTEGER, 
        current_health
      ),
      current_defense = COALESCE(
        (v_update->>'current_defense')::INTEGER, 
        current_defense
      ),
      monster_kills = COALESCE(
        (v_update->>'monster_kills')::INTEGER, 
        monster_kills
      )
    WHERE id = (v_update->>'card_instance_id')::UUID
      AND wallet_address = p_wallet_address;
    
    v_cards_updated := v_cards_updated + 1;
  END LOOP;

  RETURN jsonb_build_object(
    'success', true,
    'cards_updated', v_cards_updated
  );
END;
$$;
```

### 3. Hooks

**useBatchCrafting.ts:**
```typescript
export const useBatchCrafting = (walletAddress: string | null) => {
  const queryClient = useQueryClient();

  const craftMultiple = async (recipes: BatchCraftRecipe[]) => {
    const { data, error } = await supabase.rpc('craft_multiple_items', {
      p_wallet_address: walletAddress,
      p_recipes: recipes
    });

    if (error) throw error;

    // Invalidate cache
    await queryClient.invalidateQueries({ 
      queryKey: ['itemInstances', walletAddress] 
    });

    return data;
  };

  return { craftMultiple };
};
```

**useBatchCardUpdate.ts:**
```typescript
export const useBatchCardUpdate = (walletAddress: string | null) => {
  const queryClient = useQueryClient();

  const updateMultiple = async (updates: CardUpdate[]) => {
    const { data, error } = await supabase.rpc('batch_update_card_stats', {
      p_wallet_address: walletAddress,
      p_updates: updates
    });

    if (error) throw error;

    // Invalidate cache
    await queryClient.invalidateQueries({ 
      queryKey: ['cardInstances', walletAddress] 
    });

    return data;
  };

  return { updateMultiple };
};
```

### 4. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

**ShelterCrafting.tsx:**
- Input –¥–ª—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ (1-99)
- –ö–Ω–æ–ø–∫–∞ "–°–æ–∑–¥–∞—Ç—å –≤—Å—ë"
- –í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤
- Batch –∫—Ä–∞—Ñ—Ç —á–µ—Ä–µ–∑ `useBatchCrafting`

**MedicalBayComponent.tsx:**
- Checkbox –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞
- –ö–Ω–æ–ø–∫–∞ "–í—ã–ª–µ—á–∏—Ç—å –≤—Å–µ—Ö"
- Batch healing —á–µ—Ä–µ–∑ `useBatchCardUpdate`

**ForgeBayComponent.tsx:**
- Checkbox –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞
- –ö–Ω–æ–ø–∫–∞ "–û—Ç—Ä–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ"
- Batch repair —á–µ—Ä–µ–∑ `useBatchCardUpdate`

## ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

- **–ú–µ–Ω—å—à–µ –∑–∞–ø—Ä–æ—Å–æ–≤** - –æ–¥–∏–Ω –≤–º–µ—Å—Ç–æ N
- **–ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å** - –ª–∏–±–æ –≤—Å–µ, –ª–∏–±–æ –Ω–∏—á–µ–≥–æ
- **–õ—É—á—à–∏–π UX** - –º–∞—Å—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –æ–¥–Ω–∏–º –∫–ª–∏–∫–æ–º
- **–í–∞–ª–∏–¥–∞—Ü–∏—è** –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–æ–º

---

# –§–ê–ó–ê 4: –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø –ú–ê–ì–ê–ó–ò–ù–ê

## üéØ –¶–µ–ª—å
–û–±—ä–µ–¥–∏–Ω–∏—Ç—å 7 –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ `/shop` –≤ –æ–¥–∏–Ω –∞—Ç–æ–º–∞—Ä–Ω—ã–π RPC –≤—ã–∑–æ–≤.

## üìä –ú–µ—Ç—Ä–∏–∫–∏

### –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
```
shop_inventory:       1 –∑–∞–ø—Ä–æ—Å √ó 100ms = 100ms
user_balance:         1 –∑–∞–ø—Ä–æ—Å √ó 90ms  = 90ms
item_instances:       1 –∑–∞–ø—Ä–æ—Å √ó 110ms = 110ms
item_templates:       1 –∑–∞–ø—Ä–æ—Å √ó 100ms = 100ms
user_profile:         1 –∑–∞–ø—Ä–æ—Å √ó 80ms  = 80ms
purchase_history:     1 –∑–∞–ø—Ä–æ—Å √ó 100ms = 100ms
shop_settings:        1 –∑–∞–ø—Ä–æ—Å √ó 120ms = 120ms
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
–ò–¢–û–ì–û:                7 –∑–∞–ø—Ä–æ—Å–æ–≤ = 700ms
```

### –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
```
get_shop_data_complete(): 1 –∑–∞–ø—Ä–æ—Å √ó 120ms = 120ms
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
–ò–¢–û–ì–û:                    1 –∑–∞–ø—Ä–æ—Å = 120ms
```

### –†–µ–∑—É–ª—å—Ç–∞—Ç:
- **-85% –∑–∞–ø—Ä–æ—Å–æ–≤** (7 ‚Üí 1)
- **-82% –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–≥—Ä—É–∑–∫–∏** (700ms ‚Üí 120ms)
- **5-–º–∏–Ω—É—Ç–Ω–æ–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ**

## üîß –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

### 1. SQL –ú–∏–≥—Ä–∞—Ü–∏—è: `get_shop_data_complete`

**–§–∞–π–ª:** `supabase/migrations/20251123180000_shop_data_complete.sql`

```sql
CREATE OR REPLACE FUNCTION public.get_shop_data_complete(
  p_wallet_address TEXT
)
RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
DECLARE
  v_result JSONB;
BEGIN
  SELECT jsonb_build_object(
    'shop_inventory', (
      SELECT COALESCE(
        jsonb_agg(
          jsonb_build_object(
            'id', si.id,
            'item_id', si.item_id,
            'available_quantity', si.available_quantity,
            'last_reset_time', si.last_reset_time,
            'next_reset_time', si.next_reset_time,
            'item_template', (
              SELECT row_to_json(it.*)
              FROM item_templates it
              WHERE it.id = si.item_id
            )
          )
        ),
        '[]'::jsonb
      )
      FROM shop_inventory si
    ),
    'user_balance', (
      SELECT COALESCE(balance, 0)
      FROM game_data
      WHERE wallet_address = p_wallet_address
    ),
    'user_inventory', (
      SELECT COALESCE(jsonb_agg(
        jsonb_build_object(
          'id', ii.id,
          'template_id', ii.template_id,
          'item_id', ii.item_id,
          'name', ii.name,
          'type', ii.type
        )
      ), '[]'::jsonb)
      FROM item_instances ii
      WHERE ii.wallet_address = p_wallet_address
    ),
    'item_templates', (
      SELECT COALESCE(jsonb_agg(it.*), '[]'::jsonb)
      FROM item_templates it
    ),
    'user_profile', (
      SELECT row_to_json(gd.*)
      FROM game_data gd
      WHERE gd.wallet_address = p_wallet_address
    ),
    'purchase_history', (
      SELECT COALESCE(jsonb_agg(
        jsonb_build_object(
          'item_id', si.item_id,
          'item_name', it.name,
          'purchased_at', now()
        )
      ), '[]'::jsonb)
      FROM shop_inventory si
      LEFT JOIN item_templates it ON it.id = si.item_id
      LIMIT 10
    ),
    'shop_settings', (
      SELECT row_to_json(ss.*)
      FROM shop_settings ss
      ORDER BY ss.created_at DESC
      LIMIT 1
    )
  ) INTO v_result;

  RETURN v_result;
END;
$$;
```

### 2. Hook: `useShopDataComplete`

**–§–∞–π–ª:** `src/hooks/useShopDataComplete.ts`

```typescript
export const useShopDataComplete = (walletAddress: string | null) => {
  const { data, isLoading, error, refetch } = useQuery({
    queryKey: ['shopDataComplete', walletAddress],
    queryFn: async (): Promise<ShopDataComplete | null> => {
      if (!walletAddress) return null;

      const { data, error } = await supabase.rpc('get_shop_data_complete', {
        p_wallet_address: walletAddress
      });

      if (error) throw error;
      return typeof data === 'string' ? JSON.parse(data) : data;
    },
    enabled: !!walletAddress,
    staleTime: 5 * 60 * 1000, // 5 minutes
    gcTime: 10 * 60 * 1000,   // 10 minutes
    refetchOnWindowFocus: false,
    retry: 3,
    retryDelay: (attemptIndex) => Math.min(1000 * 2 ** attemptIndex, 10000),
  });

  return { shopData: data, isLoading, error, refetch };
};
```

### 3. –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç: `Shop.tsx`

**–î–æ:**
```typescript
// 7 –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
const { gameData } = useGameData();
const { items: shopItems } = useEnrichedShopItems();
const { inventory } = useShopRealtime();
const { itemTemplates } = useItemTemplates();
// ... –µ—â–µ 3 —Ö—É–∫–∞
```

**–ü–æ—Å–ª–µ:**
```typescript
// 1 –∑–∞–ø—Ä–æ—Å
const { shopData } = useShopDataComplete(accountId);
const displayBalance = shopData?.user_balance ?? 0;
const shopInventory = shopData?.shop_inventory ?? [];
const userInventory = shopData?.user_inventory ?? [];
```

## ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

- **–ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å** –≤–º–µ—Å—Ç–æ 7
- **–ê—Ç–æ–º–∞—Ä–Ω—ã–π —Å–Ω–∞–ø—à–æ—Ç** –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –º–∞–≥–∞–∑–∏–Ω–∞
- **–ù–µ—Ç race conditions** –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
- **–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å** –±–∞–ª–∞–Ω—Å–∞ –∏ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
- **–£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ** –Ω–∞ 5 –º–∏–Ω—É—Ç

---

# üìÅ –°–û–ó–î–ê–ù–ù–´–ï –ò –ò–ó–ú–ï–ù–ï–ù–ù–´–ï –§–ê–ô–õ–´

## SQL –ú–∏–≥—Ä–∞—Ü–∏–∏ (4):
1. ‚úÖ `supabase/migrations/20251123170314_static_data_optimization.sql`
2. ‚úÖ `supabase/migrations/20251123172436_batch_operations.sql`
3. ‚úÖ `supabase/migrations/20251123173252_enable_shop_realtime.sql`
4. ‚úÖ `supabase/migrations/20251123180000_shop_data_complete.sql`

## Hooks (9):
5. ‚úÖ `src/hooks/useStaticGameData.ts`
6. ‚úÖ `src/hooks/useBatchCrafting.ts`
7. ‚úÖ `src/hooks/useBatchCardUpdate.ts`
8. ‚úÖ `src/hooks/useShopRealtime.ts`
9. ‚úÖ `src/hooks/useShopDataComplete.ts`
10. ‚úÖ `src/hooks/useBuildingConfigs.ts` (–æ–±–Ω–æ–≤–ª–µ–Ω)
11. ‚úÖ `src/hooks/useCardDropRates.ts` (–æ–±–Ω–æ–≤–ª–µ–Ω)
12. ‚úÖ `src/hooks/useCraftingRecipes.ts` (–æ–±–Ω–æ–≤–ª–µ–Ω)
13. ‚úÖ `src/hooks/useCardUpgradeRequirements.ts` (–æ–±–Ω–æ–≤–ª–µ–Ω)
14. ‚úÖ `src/hooks/useItemTemplates.ts` (–æ–±–Ω–æ–≤–ª–µ–Ω)

## Contexts (1):
15. ‚úÖ `src/contexts/StaticGameDataContext.tsx`

## Utils (1):
16. ‚úÖ `src/utils/claimBattleRewards.ts`

## Components (4):
17. ‚úÖ `src/App.tsx` (–æ–±–Ω–æ–≤–ª–µ–Ω - –¥–æ–±–∞–≤–ª–µ–Ω StaticGameDataProvider)
18. ‚úÖ `src/components/Shop.tsx` (–æ–±–Ω–æ–≤–ª–µ–Ω - Phase 2B –∏ Phase 4)
19. ‚úÖ `src/components/game/shelter/ShelterCrafting.tsx` (–æ–±–Ω–æ–≤–ª–µ–Ω - Phase 3)
20. ‚úÖ `src/components/game/medical/MedicalBayComponent.tsx` (–æ–±–Ω–æ–≤–ª–µ–Ω - Phase 3)
21. ‚úÖ `src/components/game/forge/ForgeBayComponent.tsx` (–æ–±–Ω–æ–≤–ª–µ–Ω - Phase 3)

## –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (5):
22. ‚úÖ `docs/PHASE_1_STATIC_DATA_COMPLETE.md`
23. ‚úÖ `docs/PHASE_2_REALTIME_COMPLETE.md`
24. ‚úÖ `docs/PHASE_3_BATCH_OPERATIONS_COMPLETE.md`
25. ‚úÖ `docs/PHASE_4_SHOP_OPTIMIZATION_COMPLETE.md`
26. ‚úÖ `docs/FINAL_OPTIMIZATION_REPORT.md` (—ç—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç)

---

# üìÖ TIMELINE –†–ï–ê–õ–ò–ó–ê–¶–ò–ò

## –ù–µ–¥–µ–ª—è 1: –ê–Ω–∞–ª–∏–∑ –∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ê—É–¥–∏—Ç –≤—Å–µ—Ö API –∑–∞–ø—Ä–æ—Å–æ–≤
- –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —É–∑–∫–∏—Ö –º–µ—Å—Ç
- –ü—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ RPC —Ñ—É–Ω–∫—Ü–∏–π
- –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

## –ù–µ–¥–µ–ª—è 2: Phase 1 - Static Data
- –î–µ–Ω—å 1-2: SQL –º–∏–≥—Ä–∞—Ü–∏—è `get_static_game_data()`
- –î–µ–Ω—å 3-4: Hook `useStaticGameData` –∏ Context
- –î–µ–Ω—å 5: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ 5 —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ö—É–∫–æ–≤
- –î–µ–Ω—å 6-7: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—Ç–ª–∞–¥–∫–∞

## –ù–µ–¥–µ–ª—è 3: Phase 2 - Battle & Realtime
- –î–µ–Ω—å 1-2: SQL –º–∏–≥—Ä–∞—Ü–∏—è `apply_battle_rewards()`
- –î–µ–Ω—å 3-4: Utility `claimBattleRewards` –∏ hook
- –î–µ–Ω—å 5: SQL –º–∏–≥—Ä–∞—Ü–∏—è –¥–ª—è Realtime
- –î–µ–Ω—å 6: Hook `useShopRealtime`
- –î–µ–Ω—å 7: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

## –ù–µ–¥–µ–ª—è 4: Phase 3 - Batch Operations
- –î–µ–Ω—å 1-2: SQL –º–∏–≥—Ä–∞—Ü–∏–∏ (`craft_multiple_items`, `batch_update_card_stats`)
- –î–µ–Ω—å 3-4: Hooks (`useBatchCrafting`, `useBatchCardUpdate`)
- –î–µ–Ω—å 5-6: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ 3 –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
- –î–µ–Ω—å 7: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

## –ù–µ–¥–µ–ª—è 5: Phase 4 - Shop Optimization
- –î–µ–Ω—å 1-2: SQL –º–∏–≥—Ä–∞—Ü–∏—è `get_shop_data_complete()`
- –î–µ–Ω—å 3-4: Hook `useShopDataComplete`
- –î–µ–Ω—å 5: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ `Shop.tsx`
- –î–µ–Ω—å 6-7: –§–∏–Ω–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

**–û–±—â–µ–µ –≤—Ä–µ–º—è**: 5 –Ω–µ–¥–µ–ª—å (35 –¥–Ω–µ–π)

---

# üîÆ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –î–õ–Ø –ë–£–î–£–©–ï–ô –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ò

## 1. –ü–∞–≥–∏–Ω–∞—Ü–∏—è –¥–ª—è –±–æ–ª—å—à–∏—Ö —Å–ø–∏—Å–∫–æ–≤

### –ü—Ä–æ–±–ª–µ–º–∞:
–ù–µ–∫–æ—Ç–æ—Ä—ã–µ –∑–∞–ø—Ä–æ—Å—ã –º–æ–≥—É—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å —Å–æ—Ç–Ω–∏ –∑–∞–ø–∏—Å–µ–π –±–µ–∑ –ª–∏–º–∏—Ç–æ–≤.

### –†–µ—à–µ–Ω–∏–µ:
```typescript
// –î–æ–±–∞–≤–∏—Ç—å offset/limit –ø–∞–≥–∏–Ω–∞—Ü–∏—é
const useCardInstances = (walletAddress: string, page = 0, limit = 50) => {
  return useQuery({
    queryKey: ['cardInstances', walletAddress, page],
    queryFn: async () => {
      const { data } = await supabase
        .from('card_instances')
        .select('*')
        .eq('wallet_address', walletAddress)
        .range(page * limit, (page + 1) * limit - 1);
      return data;
    }
  });
};
```

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –°—Ä–µ–¥–Ω–∏–π
### –û–∂–∏–¥–∞–µ–º–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ: -50% –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –±–æ–ª—å—à–∏—Ö —Å–ø–∏—Å–∫–æ–≤

---

## 2. –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### –ü—Ä–æ–±–ª–µ–º–∞:
–ú–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –±–æ–ª—å—à–∏—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö –±–µ–∑ –∏–Ω–¥–µ–∫—Å–æ–≤.

### –†–µ—à–µ–Ω–∏–µ:
```sql
-- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
CREATE INDEX idx_card_instances_wallet ON card_instances(wallet_address);
CREATE INDEX idx_item_instances_wallet ON item_instances(wallet_address);
CREATE INDEX idx_shop_inventory_item ON shop_inventory(item_id);

-- Composite –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
CREATE INDEX idx_card_instances_wallet_type 
  ON card_instances(wallet_address, card_type);
```

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –í—ã—Å–æ–∫–∏–π
### –û–∂–∏–¥–∞–µ–º–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ: -30-70% –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–ø—Ä–æ—Å–æ–≤

---

## 3. Service Workers –¥–ª—è offline-first

### –ü—Ä–æ–±–ª–µ–º–∞:
–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞.

### –†–µ—à–µ–Ω–∏–µ:
```typescript
// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Service Worker API
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js')
    .then(registration => {
      console.log('SW registered:', registration);
    });
}

// –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ static assets
self.addEventListener('fetch', (event) => {
  event.respondWith(
    caches.match(event.request)
      .then(response => response || fetch(event.request))
  );
});
```

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –°—Ä–µ–¥–Ω–∏–π
### –û–∂–∏–¥–∞–µ–º–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ: Offline support, –º–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ UI

---

## 4. –í–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è –±–æ–ª—å—à–∏—Ö —Å–ø–∏—Å–∫–æ–≤

### –ü—Ä–æ–±–ª–µ–º–∞:
–†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å–æ—Ç–µ–Ω —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ DOM –∑–∞–º–µ–¥–ª—è–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.

### –†–µ—à–µ–Ω–∏–µ:
```typescript
import { useVirtualizer } from '@tanstack/react-virtual';

const VirtualizedCardList = ({ cards }: { cards: Card[] }) => {
  const parentRef = useRef<HTMLDivElement>(null);
  
  const virtualizer = useVirtualizer({
    count: cards.length,
    getScrollElement: () => parentRef.current,
    estimateSize: () => 200, // –ü—Ä–∏–º–µ—Ä–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –∫–∞—Ä—Ç—ã
  });

  return (
    <div ref={parentRef} className="h-screen overflow-auto">
      <div style={{ height: `${virtualizer.getTotalSize()}px` }}>
        {virtualizer.getVirtualItems().map(virtualItem => (
          <div
            key={virtualItem.key}
            style={{
              position: 'absolute',
              top: 0,
              left: 0,
              width: '100%',
              height: `${virtualItem.size}px`,
              transform: `translateY(${virtualItem.start}px)`
            }}
          >
            <CardDisplay card={cards[virtualItem.index]} />
          </div>
        ))}
      </div>
    </div>
  );
};
```

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –í—ã—Å–æ–∫–∏–π (–¥–ª—è –≥—Ä–∏–º—É–∞—Ä–∞, –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è)
### –û–∂–∏–¥–∞–µ–º–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ: -90% DOM nodes, +200% scroll performance

---

## 5. Image CDN –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

### –ü—Ä–æ–±–ª–µ–º–∞:
–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–∞—Ä—Ç/–ø—Ä–µ–¥–º–µ—Ç–æ–≤ –Ω–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã, –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –º–µ–¥–ª–µ–Ω–Ω–æ.

### –†–µ—à–µ–Ω–∏–µ:
```typescript
// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Cloudflare Images –∏–ª–∏ imgix
const optimizedImageUrl = (url: string, width: number) => {
  return `https://cdn.example.com/${url}?w=${width}&format=webp&quality=85`;
};

// Lazy loading —Å Intersection Observer
<img 
  src={optimizedImageUrl(card.image_url, 300)} 
  loading="lazy"
  decoding="async"
  alt={card.name}
/>

// WebP —Å fallback
<picture>
  <source srcSet={`${url}.webp`} type="image/webp" />
  <img src={`${url}.jpg`} alt={alt} />
</picture>
```

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –°—Ä–µ–¥–Ω–∏–π
### –û–∂–∏–¥–∞–µ–º–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ: -70% —Ä–∞–∑–º–µ—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π, faster load

---

## 6. Edge Functions –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

### –ü—Ä–æ–±–ª–µ–º–∞:
Cold starts –¥–ª—è —Ä–µ–¥–∫–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö edge functions.

### –†–µ—à–µ–Ω–∏–µ:
```typescript
// Warm-up —Ñ—É–Ω–∫—Ü–∏—è
Deno.cron('keep-warm', '*/5 * * * *', async () => {
  await fetch('https://your-edge-function.supabase.co/keep-warm');
});

// Connection pooling –¥–ª—è –ë–î
const pool = new Pool({
  connectionString: Deno.env.get('SUPABASE_DB_URL'),
  max: 10,
  idleTimeoutMillis: 30000
});
```

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –ù–∏–∑–∫–∏–π
### –û–∂–∏–¥–∞–µ–º–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ: -50% cold start time

---

## 7. Incremental Static Regeneration –¥–ª—è —Å—Ç–∞—Ç–∏–∫–∏

### –ü—Ä–æ–±–ª–µ–º–∞:
–°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –¥–∞–∂–µ –∫–æ–≥–¥–∞ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å.

### –†–µ—à–µ–Ω–∏–µ:
```typescript
// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ ETags –¥–ª—è conditional requests
const { data, headers } = await fetch('/api/static-data', {
  headers: {
    'If-None-Match': cachedETag
  }
});

if (headers.get('status') === '304') {
  // Use cached data
  return cachedData;
}

// Update cache with new ETag
cacheData(data, headers.get('ETag'));
```

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –ù–∏–∑–∫–∏–π
### –û–∂–∏–¥–∞–µ–º–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ: -95% bandwidth –¥–ª—è unchanged data

---

## 8. Background sync –¥–ª—è offline actions

### –ü—Ä–æ–±–ª–µ–º–∞:
–ü–æ—Ç–µ—Ä—è –¥–µ–π—Å—Ç–≤–∏–π –ø—Ä–∏ –≤—Ä–µ–º–µ–Ω–Ω–æ–º –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞.

### –†–µ—à–µ–Ω–∏–µ:
```typescript
// –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è background sync
navigator.serviceWorker.ready.then(registration => {
  registration.sync.register('sync-battle-rewards');
});

// –í Service Worker
self.addEventListener('sync', (event) => {
  if (event.tag === 'sync-battle-rewards') {
    event.waitUntil(syncBattleRewards());
  }
});

async function syncBattleRewards() {
  const pendingRewards = await getPendingRewards();
  for (const reward of pendingRewards) {
    await claimBattleRewards(reward);
  }
}
```

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –°—Ä–µ–¥–Ω–∏–π
### –û–∂–∏–¥–∞–µ–º–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ: Better UX, no data loss

---

## 9. Prefetching –∏ route-based code splitting

### –ü—Ä–æ–±–ª–µ–º–∞:
–ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ–≥–æ JS bundle –Ω–∞ –Ω–∞—á–∞–ª—å–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ.

### –†–µ—à–µ–Ω–∏–µ:
```typescript
// React.lazy –¥–ª—è code splitting
const Shop = lazy(() => import('./components/Shop'));
const Grimoire = lazy(() => import('./components/Grimoire'));

// Prefetch –ø—Ä–∏ hover
<Link 
  to="/shop"
  onMouseEnter={() => import('./components/Shop')}
>
  Go to Shop
</Link>

// Route-based splitting —Å React Router
<Routes>
  <Route path="/shop" element={
    <Suspense fallback={<Loading />}>
      <Shop />
    </Suspense>
  } />
</Routes>
```

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –í—ã—Å–æ–∫–∏–π
### –û–∂–∏–¥–∞–µ–º–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ: -60% initial bundle, faster FCP

---

## 10. Database —Ñ—É–Ω–∫—Ü–∏–∏ –≤–º–µ—Å—Ç–æ client-side –≤—ã—á–∏—Å–ª–µ–Ω–∏–π

### –ü—Ä–æ–±–ª–µ–º–∞:
–°–ª–æ–∂–Ω—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è (—Å—Ç–∞—Ç—ã –∫–∞—Ä—Ç, –¥—Ä–æ–ø—ã) –¥–µ–ª–∞—é—Ç—Å—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ.

### –†–µ—à–µ–Ω–∏–µ:
```sql
-- –í—ã—á–∏—Å–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
CREATE OR REPLACE FUNCTION calculate_card_stats(
  p_card_data JSONB,
  p_rarity INTEGER,
  p_class TEXT
)
RETURNS JSONB
LANGUAGE plpgsql
AS $$
DECLARE
  v_base_stats JSONB;
  v_multipliers JSONB;
  v_final_stats JSONB;
BEGIN
  -- –ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–∑–æ–≤—ã—Ö —Å—Ç–∞—Ç–æ–≤ –∏ –º–Ω–æ–∂–∏—Ç–µ–ª–µ–π
  SELECT base_stats INTO v_base_stats FROM hero_base_stats;
  SELECT multipliers INTO v_multipliers 
  FROM class_multipliers 
  WHERE class_name = p_class;

  -- –í—ã—á–∏—Å–ª–µ–Ω–∏–µ —Ñ–∏–Ω–∞–ª—å–Ω—ã—Ö —Å—Ç–∞—Ç–æ–≤
  v_final_stats := jsonb_build_object(
    'power', (v_base_stats->>'power')::INTEGER * (v_multipliers->>'power')::NUMERIC,
    'health', (v_base_stats->>'health')::INTEGER * (v_multipliers->>'health')::NUMERIC
    -- ... –¥—Ä—É–≥–∏–µ —Å—Ç–∞—Ç—ã
  );

  RETURN v_final_stats;
END;
$$;
```

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –°—Ä–µ–¥–Ω–∏–π
### –û–∂–∏–¥–∞–µ–º–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ: -100% client CPU, consistency

---

# üìà –î–û–õ–ì–û–°–†–û–ß–ù–´–ï –ú–ï–¢–†–ò–ö–ò

## Performance Budget

| –ú–µ—Ç—Ä–∏–∫–∞ | –¢–µ–∫—É—â–µ–µ | –¶–µ–ª–µ–≤–æ–µ | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç |
|---------|---------|---------|-----------|
| **First Contentful Paint** | 1.2s | <0.8s | üî¥ High |
| **Largest Contentful Paint** | 2.1s | <1.5s | üî¥ High |
| **Time to Interactive** | 3.5s | <2.0s | üü° Medium |
| **Total Blocking Time** | 450ms | <200ms | üü° Medium |
| **Cumulative Layout Shift** | 0.08 | <0.1 | üü¢ Low |
| **DB Query Time (avg)** | 120ms | <80ms | üî¥ High |
| **API Requests per session** | 5 | <3 | üü° Medium |
| **Bundle Size** | 2.8MB | <2.0MB | üü° Medium |

---

## Monitoring –∏ Observability

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:

1. **Sentry** - Error tracking –∏ performance monitoring
2. **LogRocket** - Session replay –¥–ª—è debugging
3. **PostHog** - Product analytics
4. **Grafana + Prometheus** - Infrastructure monitoring
5. **Supabase Dashboard** - DB performance metrics

### Key Performance Indicators:

```typescript
// Custom metrics tracking
const trackPerformance = () => {
  // DB query time
  const dbQueryTime = performance.measure('db-query', 'query-start', 'query-end');
  
  // Component render time
  const renderTime = performance.measure('render', 'render-start', 'render-end');
  
  // Cache hit rate
  const cacheHitRate = (cacheHits / totalQueries) * 100;
  
  // Send to analytics
  analytics.track('performance_metrics', {
    dbQueryTime: dbQueryTime.duration,
    renderTime: renderTime.duration,
    cacheHitRate
  });
};
```

---

# üéØ –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

## –î–æ—Å—Ç–∏–≥–Ω—É—Ç—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

–ß–µ—Ç—ã—Ä–µ—Ö—Ñ–∞–∑–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –ø—Ä–∏–≤–µ–ª–∞ –∫:

- ‚úÖ **-90% –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î** (54 ‚Üí 5)
- ‚úÖ **-83% –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–≥—Ä—É–∑–∫–∏** (1133ms ‚Üí 187ms)
- ‚úÖ **-100% polling** (–∑–∞–º–µ–Ω–∞ –Ω–∞ Real-time)
- ‚úÖ **–ê—Ç–æ–º–∞—Ä–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏** –¥–ª—è –≤—Å–µ—Ö –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ **–£–ª—É—á—à–µ–Ω–Ω—ã–π UX** —Å batch –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏
- ‚úÖ **–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö** —á–µ—Ä–µ–∑ –µ–¥–∏–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –ø—Ä–∞–≤–¥—ã
- ‚úÖ **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å** —á–µ—Ä–µ–∑ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –∏ error handling

## –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã

1. **–ê–≥—Ä–µ–≥–∞—Ü–∏—è**: –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –æ–¥–∏–Ω
2. **–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ TTL
3. **Real-time**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–æ–∫ –≤–º–µ—Å—Ç–æ polling
4. **Batch –æ–ø–µ—Ä–∞—Ü–∏–∏**: –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∑–∞ –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å
5. **–ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å**: –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î
6. **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å**: –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - –í–Ω–µ–¥—Ä–µ–Ω–∏–µ observability –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
2. **–ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è** - –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ —á–µ—Ä–µ–∑ –∏–Ω–¥–µ–∫—Å—ã
3. **–í–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è** - –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –±–æ–ª—å—à–∏—Ö —Å–ø–∏—Å–∫–æ–≤
4. **Code splitting** - –£–º–µ–Ω—å—à–µ–Ω–∏–µ initial bundle
5. **Image optimization** - CDN –∏ —Ñ–æ—Ä–º–∞—Ç—ã –Ω–æ–≤–æ–≥–æ –ø–æ–∫–æ–ª–µ–Ω–∏—è

---

**–°—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞**: ‚úÖ **–í–°–ï 4 –§–ê–ó–´ –ó–ê–í–ï–†–®–ï–ù–´**

**–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è**: 2025-11-23

**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞**: 1.0 Final

**–ê–≤—Ç–æ—Ä**: AI Optimization Team

---

*–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç —è–≤–ª—è–µ—Ç—Å—è —Ñ–∏–Ω–∞–ª—å–Ω—ã–º –æ—Ç—á–µ—Ç–æ–º –æ –ø—Ä–æ–≤–µ–¥–µ–Ω–Ω–æ–π –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏. –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã, –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã –∏ –≥–æ—Ç–æ–≤—ã –∫ production deployment.*
