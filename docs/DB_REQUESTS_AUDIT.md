# üîç –ê–£–î–ò–¢ –ó–ê–ü–†–û–°–û–í –ö –ë–ê–ó–ï –î–ê–ù–ù–´–•

**–î–∞—Ç–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è:** 2025-11-23  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω  
**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:** 60-75% —Å–æ–∫—Ä–∞—â–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤

---

## üìä EXECUTIVE SUMMARY

### –ö–ª—é—á–µ–≤—ã–µ –Ω–∞—Ö–æ–¥–∫–∏:
- **–í—Å–µ–≥–æ –Ω–∞–π–¥–µ–Ω–æ —Ç–æ—á–µ–∫ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ –ë–î:** ~150+
- **RPC —Ñ—É–Ω–∫—Ü–∏–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:** 40+
- **Edge Functions:** 23
- **Real-time –ø–æ–¥–ø–∏—Å–æ–∫:** 8+
- **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º:** 5
- **–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:** –í–´–°–û–ö–ê–Ø (60-75% —Å–æ–∫—Ä–∞—â–µ–Ω–∏–µ)

### –ì–ª–∞–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:
1. ‚ùå **–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –æ–¥–Ω–∏—Ö –∏ —Ç–µ—Ö –∂–µ –¥–∞–Ω–Ω—ã—Ö** (gameData, itemInstances, cardInstances)
2. ‚ùå **–†–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –ø–æ–¥–ø–∏—Å–æ–∫ –¥–ª—è —Ä–µ–¥–∫–æ –º–µ–Ω—è—é—â–∏—Ö—Å—è –¥–∞–Ω–Ω—ã—Ö** (configs, recipes)
3. ‚ùå **–ü–æ–ª–∏–Ω–≥ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç** (shop_inventory)
4. ‚ùå **–û—Ç–¥–µ–ª—å–Ω—ã–µ RPC –¥–ª—è –∫–∞–∂–¥–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏** –≤ –±–æ–µ–≤–æ–π —Å–∏—Å—Ç–µ–º–µ (—É—Å—Ç–∞—Ä–µ–≤—à–∏–π –∫–æ–¥)
5. ‚ùå **–ù–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è –ø–∞–≥–∏–Ω–∞—Ü–∏—è** –¥–ª—è –±–æ–ª—å—à–∏—Ö —Å–ø–∏—Å–∫–æ–≤

---

## üéØ –ê–ù–ê–õ–ò–ó –ü–û –≠–ö–†–ê–ù–ê–ú/–§–ò–ß–ê–ú

### 1. **–ó–ê–ì–†–£–ó–ö–ê –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø (App Init)**

#### –¢–µ–∫—É—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã:
```typescript
// GameDataContext
1. RPC: get_game_data_by_wallet           // –í—Å–µ –¥–∞–Ω–Ω—ã–µ –∏–≥—Ä–æ–∫–∞
2. RPC: ensure_game_data_exists           // –°–æ–∑–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–∞ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
3. RPC: get_item_instances_by_wallet      // –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—Ä–µ–¥–º–µ—Ç–æ–≤
4. RPC: get_card_instances_by_wallet      // –≠–∫–∑–µ–º–ø–ª—è—Ä—ã –∫–∞—Ä—Ç
5. SELECT: building_configs               // –ö–æ–Ω—Ñ–∏–≥–∏ –∑–¥–∞–Ω–∏–π
6. SELECT: crafting_recipes               // –†–µ—Ü–µ–ø—Ç—ã –∫—Ä–∞—Ñ—Ç–∞
7. SELECT: item_templates                 // –®–∞–±–ª–æ–Ω—ã –ø—Ä–µ–¥–º–µ—Ç–æ–≤
8. SELECT: shop_inventory                 // –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –º–∞–≥–∞–∑–∏–Ω–∞
9. SELECT: marketplace_listings           // –õ–∏—Å—Ç–∏–Ω–≥–∏ –º–∞—Ä–∫–µ—Ç–∞
```

**–ò—Ç–æ–≥–æ:** 9 –∑–∞–ø—Ä–æ—Å–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ

#### –ü—Ä–æ–±–ª–µ–º—ã:
- ‚ùå `building_configs`, `crafting_recipes`, `item_templates` –∑–∞–ø—Ä–∞—à–∏–≤–∞—é—Ç—Å—è –Ω–∞ –ö–ê–ñ–î–û–ô —Å—Ç—Ä–∞–Ω–∏—Ü–µ
- ‚ùå Real-time –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –∫–æ–Ω—Ñ–∏–≥–∏ (–º–µ–Ω—è—é—Ç—Å—è —Ä–µ–¥–∫–æ, –∞–¥–º–∏–Ω–æ–º)
- ‚ùå –ù–µ—Ç —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–µ—à–∞ –¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö

#### –†–µ—à–µ–Ω–∏–µ:
```typescript
// ‚úÖ –û–±—ä–µ–¥–∏–Ω–∏—Ç—å –≤—Å–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –≤ –æ–¥–∏–Ω RPC
CREATE FUNCTION get_static_game_data() RETURNS JSON AS $$
  SELECT json_build_object(
    'building_configs', (SELECT json_agg(row_to_json(bc)) FROM building_configs bc WHERE is_active = true),
    'crafting_recipes', (SELECT json_agg(row_to_json(cr)) FROM crafting_recipes cr WHERE is_active = true),
    'item_templates', (SELECT json_agg(row_to_json(it)) FROM item_templates it),
    'card_drop_rates', (SELECT json_agg(row_to_json(cdr)) FROM card_class_drop_rates cdr)
  );
$$ LANGUAGE sql STABLE;

// ‚úÖ –ö–µ—à–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ 1 —á–∞—Å (–º–µ–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–æ–º)
const { data } = useQuery({
  queryKey: ['staticGameData'],
  queryFn: () => supabase.rpc('get_static_game_data'),
  staleTime: 3600000, // 1 —á–∞—Å
  gcTime: 7200000     // 2 —á–∞—Å–∞
});
```

**–°–æ–∫—Ä–∞—â–µ–Ω–∏–µ:** 9 ‚Üí 5 –∑–∞–ø—Ä–æ—Å–æ–≤ (-44%)

---

### 2. **–°–¢–†–ê–ù–ò–¶–ê /EQUIPMENT**

#### –¢–µ–∫—É—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã:
```typescript
1. RPC: get_game_data_by_wallet           // –£–∂–µ –≤ –∫–µ—à–µ GameDataContext
2. RPC: get_item_instances_by_wallet      // –£–∂–µ –≤ –∫–µ—à–µ ItemInstancesContext
3. RPC: get_card_instances_by_wallet      // –£–∂–µ –≤ –∫–µ—à–µ CardInstancesContext
4. SELECT: item_templates                 // –ó–∞–≥—Ä—É–∂–µ–Ω–æ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
5. SELECT: card_upgrade_requirements      // –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
```

**–ò—Ç–æ–≥–æ:** 5 –∑–∞–ø—Ä–æ—Å–æ–≤ (3 –∏–∑ –Ω–∏—Ö –¥—É–±–ª–∏—Ä—É—é—Ç—Å—è)

#### –ü—Ä–æ–±–ª–µ–º—ã:
- ‚ùå –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∏–∑-–∑–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –µ–¥–∏–Ω–æ–≥–æ –∫–µ—à–∞
- ‚ùå `card_upgrade_requirements` –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–π —Ä–∞–∑
- ‚ùå –ù–µ—Ç –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –¥–ª—è –±–æ–ª—å—à–∏—Ö —Å–ø–∏—Å–∫–æ–≤ –ø—Ä–µ–¥–º–µ—Ç–æ–≤

#### –†–µ—à–µ–Ω–∏–µ:
```typescript
// ‚úÖ –í—Å–µ –¥–∞–Ω–Ω—ã–µ —É–∂–µ –≤ –∫–µ—à–µ React Query
// ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –≤–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏—é –¥–ª—è –±–æ–ª—å—à–∏—Ö —Å–ø–∏—Å–∫–æ–≤
import { useVirtualizer } from '@tanstack/react-virtual';

// ‚úÖ –ö–µ—à–∏—Ä–æ–≤–∞—Ç—å card_upgrade_requirements –Ω–∞ —á–∞—Å
const { data: upgradeReqs } = useQuery({
  queryKey: ['cardUpgradeRequirements'],
  queryFn: () => supabase.from('card_upgrade_requirements').select('*'),
  staleTime: 3600000
});
```

**–°–æ–∫—Ä–∞—â–µ–Ω–∏–µ:** 5 ‚Üí 1 –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å (-80%)

---

### 3. **–°–¢–†–ê–ù–ò–¶–ê /SHOP**

#### –¢–µ–∫—É—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã:
```typescript
1. SELECT: shop_inventory                 // –ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç polling
2. SELECT: item_templates                 // –£–∂–µ –≤ –∫–µ—à–µ
3. Edge Function: shop-purchase           // –ü—Ä–∏ –ø–æ–∫—É–ø–∫–µ
4. Edge Function: shop-reset              // –ü—Ä–∏ —Å–±—Ä–æ—Å–µ (–∞–¥–º–∏–Ω)

// –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:
- Polling –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç —á–µ—Ä–µ–∑ setInterval
- –¢–∞–π–º–µ—Ä –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É (client-side)
```

**–ò—Ç–æ–≥–æ:** 2 –∑–∞–ø—Ä–æ—Å–∞ + polling –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç

#### –ü—Ä–æ–±–ª–µ–º—ã:
- ‚ùå Polling –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç –Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–µ–Ω
- ‚ùå –¢–∞–π–º–µ—Ä –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ (–º–æ–∂–µ—Ç —Ä–∞—Å—Ö–æ–¥–∏—Ç—å—Å—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º)
- ‚ùå –ù–µ—Ç real-time —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –ø–æ–∫—É–ø–∫–∞—Ö –¥—Ä—É–≥–∏—Ö –∏–≥—Ä–æ–∫–æ–≤

#### –†–µ—à–µ–Ω–∏–µ:
```typescript
// ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Supabase Real-time –¥–ª—è shop_inventory
const channel = supabase
  .channel('shop_inventory_changes')
  .on('postgres_changes', {
    event: 'UPDATE',
    schema: 'public',
    table: 'shop_inventory'
  }, () => queryClient.invalidateQueries(['shopInventory']))
  .subscribe();

// ‚úÖ –£–±—Ä–∞—Ç—å polling, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ real-time
// ‚úÖ –¢–∞–π–º–µ—Ä —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—Ç—å –æ—Ç next_reset_time –∏–∑ –ë–î
```

**–°–æ–∫—Ä–∞—â–µ–Ω–∏–µ:** –£–±—Ä–∞—Ç—å polling (-100% –ø–æ—Å—Ç–æ—è–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤)

---

### 4. **–°–¢–†–ê–ù–ò–¶–ê /SHELTER (–£–ë–ï–ñ–ò–©–ï)**

#### –¢–µ–∫—É—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã:
```typescript
1. RPC: get_game_data_by_wallet           // –í –∫–µ—à–µ
2. SELECT: building_configs               // –í –∫–µ—à–µ
3. SELECT: crafting_recipes               // –í –∫–µ—à–µ
4. RPC: get_item_instances_by_wallet      // –í –∫–µ—à–µ
5. RPC: start_building_upgrade            // –ü—Ä–∏ –∞–ø–≥—Ä–µ–π–¥–µ
6. RPC: instant_complete_building         // –ü—Ä–∏ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
7. Edge Function: instant-complete-building // –î—É–±–ª—å RPC
```

**–ò—Ç–æ–≥–æ:** 4 –∑–∞–ø—Ä–æ—Å–∞ –≤ –∫–µ—à–µ + 2-3 –ø—Ä–∏ –¥–µ–π—Å—Ç–≤–∏—è—Ö

#### –ü—Ä–æ–±–ª–µ–º—ã:
- ‚ùå –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ RPC –∏ Edge Function –¥–ª—è instant complete
- ‚ùå –û—Ç–¥–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–ø–≥—Ä–µ–π–¥–∞ –∑–¥–∞–Ω–∏—è
- ‚ùå –ù–µ—Ç –±–∞—Ç—á–∏–Ω–≥–∞ –¥–ª—è –º–∞—Å—Å–æ–≤—ã—Ö –∫—Ä–∞—Ñ—Ç–æ–≤

#### –†–µ—à–µ–Ω–∏–µ:
```typescript
// ‚úÖ –£–±—Ä–∞—Ç—å –¥—É–±–ª–∏—Ä—É—é—â—É—é Edge Function, –æ—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ RPC
// ‚úÖ –î–æ–±–∞–≤–∏—Ç—å batch crafting RPC
CREATE FUNCTION craft_multiple_items(
  p_wallet_address TEXT,
  p_recipes JSONB -- [{ recipe_id, quantity }]
) RETURNS JSONB;

// ‚úÖ –û–±—ä–µ–¥–∏–Ω–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Ä–µ—Å—É—Ä—Å–æ–≤ –∏ –∫—Ä–∞—Ñ—Ç –≤ –æ–¥–Ω—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
```

**–°–æ–∫—Ä–∞—â–µ–Ω–∏–µ:** 7 ‚Üí 4 –∑–∞–ø—Ä–æ—Å–∞ (-43%)

---

### 5. **–°–¢–†–ê–ù–ò–¶–ê /MARKETPLACE**

#### –¢–µ–∫—É—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã:
```typescript
1. SELECT: marketplace_listings           // Real-time –ø–æ–¥–ø–∏—Å–∫–∞
2. SELECT: game_data (cards, balance)     // –ü—Ä–∏ –ø–æ–∫—É–ø–∫–µ
3. Edge Function: marketplace-buy-nft     // –ü—Ä–∏ –ø–æ–∫—É–ø–∫–µ
4. Edge Function: marketplace-create-nft-listing // –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏
5. RPC: cancel_marketplace_listing        // –ü—Ä–∏ –æ—Ç–º–µ–Ω–µ
```

**–ò—Ç–æ–≥–æ:** 1 –Ω–∞—á–∞–ª—å–Ω—ã–π + 1-2 –ø—Ä–∏ –¥–µ–π—Å—Ç–≤–∏—è—Ö + real-time

#### –ü—Ä–æ–±–ª–µ–º—ã:
- ‚ùå Real-time –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –í–°–ï –ª–∏—Å—Ç–∏–Ω–≥–∏ (–º–æ–∂–µ—Ç –±—ã—Ç—å –º–Ω–æ–≥–æ)
- ‚ùå –ù–µ—Ç –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
- ‚ùå –ù–µ—Ç —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î

#### –†–µ—à–µ–Ω–∏–µ:
```typescript
// ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –ø–∞–≥–∏–Ω–∞—Ü–∏—é –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é
const { data } = useInfiniteQuery({
  queryKey: ['marketplaceListings', filters],
  queryFn: ({ pageParam = 0 }) => 
    supabase
      .from('marketplace_listings')
      .select('*', { count: 'exact' })
      .eq('status', 'active')
      .range(pageParam, pageParam + 19) // 20 per page
      .order('created_at', { ascending: false })
});

// ‚úÖ Real-time —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
// ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã: (status, created_at), (seller_id, status)
```

**–°–æ–∫—Ä–∞—â–µ–Ω–∏–µ:** –£–ª—É—á—à–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –ª–∏—Å—Ç–∏–Ω–≥–æ–≤

---

### 6. **–ë–û–ï–í–ê–Ø –°–ò–°–¢–ï–ú–ê (DUNGEON)**

#### ‚ùå –°–¢–ê–†–ê–Ø –°–ò–°–¢–ï–ú–ê (–î–û –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ò):
```typescript
// –ü—Ä–∏ –∫–∞–∂–¥–æ–º —É–±–∏–π—Å—Ç–≤–µ –º–æ–Ω—Å—Ç—Ä–∞:
1. RPC: increment_card_monster_kills      // x3 (–¥–ª—è –∫–∞–∂–¥–æ–π –∫–∞—Ä—Ç—ã –≤ –∫–æ–º–∞–Ω–¥–µ)
2. RPC: update_card_instance_health       // x3
3. RPC: update_card_instance_defense      // x3
4. INSERT: item_instances                 // x1-5 (–¥—Ä–æ–ø –ø—Ä–µ–¥–º–µ—Ç–æ–≤)
5. UPDATE: game_data (balance, exp)       // x1

// –ü—Ä–∏ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–∏ 10 —É—Ä–æ–≤–Ω–µ–π:
–í—Å–µ–≥–æ: ~80-120 –∑–∞–ø—Ä–æ—Å–æ–≤ (!)
```

#### ‚úÖ –ù–û–í–ê–Ø –°–ò–°–¢–ï–ú–ê (–†–ï–ê–õ–ò–ó–û–í–ê–ù–ê):
```typescript
// –í–µ—Å—å –±–æ–π –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º —Å—Ç–µ–π—Ç–µ
// –ü—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ –ø–æ–¥–∑–µ–º–µ–ª—å—è - –û–î–ò–ù –∑–∞–ø—Ä–æ—Å:
Edge Function: claim-battle-rewards {
  coins, experience, items[], cardKills[], cardHealthUpdates[]
}

// –í–Ω—É—Ç—Ä–∏ –æ–¥–Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è:
RPC: apply_battle_rewards() // –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∞—Ç–æ–º–∞—Ä–Ω–æ
```

**–°–æ–∫—Ä–∞—â–µ–Ω–∏–µ:** 80-120 ‚Üí 1 –∑–∞–ø—Ä–æ—Å (-99%)  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–ï–ê–õ–ò–ó–û–í–ê–ù–û (—Å–º. docs/BATTLE_OPTIMIZATION.md)

---

### 7. **–°–¢–†–ê–ù–ò–¶–ê /TEAM (–ö–û–ú–ê–ù–î–ê)**

#### –¢–µ–∫—É—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã:
```typescript
1. RPC: get_game_data_by_wallet           // –í –∫–µ—à–µ
2. RPC: get_card_instances_by_wallet      // –í –∫–µ—à–µ
3. RPC: get_item_instances_by_wallet      // –í –∫–µ—à–µ
4. UPDATE: game_data.selected_team        // –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
```

**–ò—Ç–æ–≥–æ:** 3 –≤ –∫–µ—à–µ + 1 –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏

#### –ü—Ä–æ–±–ª–µ–º—ã:
- ‚ùå –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ selected_team –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–æ—Å—Ç–∞–≤–∞
- ‚ùå –ù–µ—Ç debounce –¥–ª—è —á–∞—Å—Ç—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
- ‚ùå Infinite rerender –∏–∑-–∑–∞ useEffect –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

#### –†–µ—à–µ–Ω–∏–µ:
```typescript
// ‚úÖ Debounce –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã
import { useDebouncedCallback } from 'use-debounce';

const debouncedUpdateTeam = useDebouncedCallback(
  (team) => updateGameData({ selectedTeam: team }),
  1000 // 1 —Å–µ–∫—É–Ω–¥–∞
);

// ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ useEffect
// ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å useMemo –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏–π
```

**–°–æ–∫—Ä–∞—â–µ–Ω–∏–µ:** –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ª–∏—à–Ω–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏

---

## üîß –û–ë–©–ò–ï –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ò

### 1. **–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ**

#### –ü—Ä–æ–±–ª–µ–º–∞:
```typescript
// ‚ùå –ö–∞–∂–¥—ã–π —Ö—É–∫ –¥–µ–ª–∞–µ—Ç —Å–≤–æ–π –∑–∞–ø—Ä–æ—Å
useItemInstances() ‚Üí RPC get_item_instances
useCardInstances() ‚Üí RPC get_card_instances
useGameData() ‚Üí RPC get_game_data
```

#### –†–µ—à–µ–Ω–∏–µ:
```typescript
// ‚úÖ React Query —Å –≥–ª–æ–±–∞–ª—å–Ω—ã–º–∏ –∫–ª—é—á–∞–º–∏
// ‚úÖ Contexts –¥–ª—è shared state (—É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ):
- GameDataContext
- ItemInstancesContext (TODO)
- CardInstancesContext (TODO)
```

---

### 2. **–ë–∞—Ç—á–∏–Ω–≥ –∑–∞–ø—Ä–æ—Å–æ–≤**

#### –ü—Ä–æ–±–ª–µ–º–∞:
```typescript
// ‚ùå 10 –æ—Ç–¥–µ–ª—å–Ω—ã—Ö INSERT –≤ item_instances
for (const item of items) {
  await supabase.from('item_instances').insert(item);
}
```

#### –†–µ—à–µ–Ω–∏–µ:
```typescript
// ‚úÖ –û–¥–∏–Ω batch INSERT
await supabase.from('item_instances').insert(items);

// ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å RPC –¥–ª—è —Å–ª–æ–∂–Ω–æ–π –ª–æ–≥–∏–∫–∏
RPC: add_item_instances(p_items JSONB)
```

---

### 3. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è Real-time**

#### –ü—Ä–æ–±–ª–µ–º–∞:
```typescript
// ‚ùå Real-time –Ω–∞ —Ä–µ–¥–∫–æ –º–µ–Ω—è—é—â–∏–µ—Å—è —Ç–∞–±–ª–∏—Ü—ã
- building_configs (–º–µ–Ω—è–µ—Ç —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω)
- crafting_recipes (–º–µ–Ω—è–µ—Ç —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω)
- item_templates (–º–µ–Ω—è–µ—Ç —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω)
```

#### –†–µ—à–µ–Ω–∏–µ:
```typescript
// ‚úÖ –£–±—Ä–∞—Ç—å real-time, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å long caching
staleTime: 3600000 // 1 —á–∞—Å

// ‚úÖ –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫–µ—à–∞ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –¥–µ–π—Å—Ç–≤–∏–π –∞–¥–º–∏–Ω–∞
// (—á–µ—Ä–µ–∑ —Å–æ–±—ã—Ç–∏–µ –æ—Ç Edge Function)
```

---

### 4. **–ü–∞–≥–∏–Ω–∞—Ü–∏—è –∏ –≤–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è**

#### –ü—Ä–æ–±–ª–µ–º–∞:
```typescript
// ‚ùå –ó–∞–≥—Ä—É–∑–∫–∞ –í–°–ï–• –ø—Ä–µ–¥–º–µ—Ç–æ–≤/–∫–∞—Ä—Ç —Å—Ä–∞–∑—É
SELECT * FROM item_instances WHERE wallet_address = '...'
// –ú–æ–∂–µ—Ç –±—ã—Ç—å 1000+ –∑–∞–ø–∏—Å–µ–π
```

#### –†–µ—à–µ–Ω–∏–µ:
```typescript
// ‚úÖ Infinite scroll —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
useInfiniteQuery({
  queryKey: ['items', filters],
  queryFn: ({ pageParam = 0 }) => 
    supabase
      .from('item_instances')
      .select('*')
      .range(pageParam, pageParam + 49)
});

// ‚úÖ –í–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è UI
import { useVirtualizer } from '@tanstack/react-virtual';
```

---

## üìà –ú–ï–¢–†–ò–ö–ò –ò –ò–ù–î–ï–ö–°–´ –ë–î

### –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –∏–Ω–¥–µ–∫—Å—ã:

```sql
-- ‚úÖ –î–æ–±–∞–≤–∏—Ç—å —Å–æ—Å—Ç–∞–≤–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
CREATE INDEX idx_item_instances_wallet_template 
ON item_instances(wallet_address, template_id);

CREATE INDEX idx_card_instances_wallet_template 
ON card_instances(wallet_address, card_template_id);

CREATE INDEX idx_marketplace_status_created 
ON marketplace_listings(status, created_at DESC);

CREATE INDEX idx_shop_inventory_item 
ON shop_inventory(item_id, available_quantity);
```

---

## üéØ –ü–õ–ê–ù –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ò (–ü–†–ò–û–†–ò–¢–ï–¢–´)

### üî¥ –ö–†–ò–¢–ò–ß–ù–´–ï (–°–î–ï–õ–ê–¢–¨ –°–ï–ô–ß–ê–°):

1. **–°–æ–∑–¥–∞—Ç—å RPC `get_static_game_data`**
   - –û–±—ä–µ–¥–∏–Ω–∏—Ç—å building_configs, crafting_recipes, item_templates
   - –ö–µ—à –Ω–∞ 1 —á–∞—Å
   - **–°–æ–∫—Ä–∞—â–µ–Ω–∏–µ:** 3 –∑–∞–ø—Ä–æ—Å–∞ ‚Üí 1

2. **–£–±—Ä–∞—Ç—å polling shop_inventory**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Supabase Real-time
   - **–°–æ–∫—Ä–∞—â–µ–Ω–∏–µ:** -100% –ø–æ—Å—Ç–æ—è–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

3. **–î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã –ë–î**
   - –°–æ—Å—Ç–∞–≤–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è wallet_address
   - **–£–ª—É—á—à–µ–Ω–∏–µ:** -50% –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–ø—Ä–æ—Å–æ–≤

4. **–ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å `claim-battle-rewards`**
   - –ó–∞–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ä—É—é —Å–∏—Å—Ç–µ–º—É –±–æ—è
   - **–°–æ–∫—Ä–∞—â–µ–Ω–∏–µ:** 80-120 ‚Üí 1 –∑–∞–ø—Ä–æ—Å

### üü° –°–†–ï–î–ù–ò–ï (–°–õ–ï–î–£–Æ–©–ê–Ø –ù–ï–î–ï–õ–Ø):

5. **–°–æ–∑–¥–∞—Ç—å ItemInstancesContext**
   - –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞—Ç—å –∫–µ—à item_instances
   - **–°–æ–∫—Ä–∞—â–µ–Ω–∏–µ:** -30% –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö—Å—è –∑–∞–ø—Ä–æ—Å–æ–≤

6. **–°–æ–∑–¥–∞—Ç—å CardInstancesContext**
   - –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞—Ç—å –∫–µ—à card_instances
   - **–°–æ–∫—Ä–∞—â–µ–Ω–∏–µ:** -30% –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö—Å—è –∑–∞–ø—Ä–æ—Å–æ–≤

7. **–î–æ–±–∞–≤–∏—Ç—å –ø–∞–≥–∏–Ω–∞—Ü–∏—é marketplace**
   - useInfiniteQuery
   - **–£–ª—É—á—à–µ–Ω–∏–µ:** –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ

8. **Batch crafting RPC**
   - craft_multiple_items()
   - **–°–æ–∫—Ä–∞—â–µ–Ω–∏–µ:** N ‚Üí 1 –∑–∞–ø—Ä–æ—Å

### üü¢ –ù–ò–ó–ö–ò–ï (–ü–û–ó–ñ–ï):

9. **–í–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è –±–æ–ª—å—à–∏—Ö —Å–ø–∏—Å–∫–æ–≤**
   - useVirtualizer –¥–ª—è –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
   - **–£–ª—É—á—à–µ–Ω–∏–µ:** –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å UI

10. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è Edge Functions**
    - –û–±—ä–µ–¥–∏–Ω–∏—Ç—å –ø–æ—Ö–æ–∂–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏
    - **–°–æ–∫—Ä–∞—â–µ–Ω–∏–µ:** 23 ‚Üí ~15 —Ñ—É–Ω–∫—Ü–∏–π

---

## üìä –ò–¢–û–ì–û–í–ê–Ø –û–¶–ï–ù–ö–ê

### –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
- **–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:** 9 –∑–∞–ø—Ä–æ—Å–æ–≤
- **Equipment:** 5 –∑–∞–ø—Ä–æ—Å–æ–≤ (3 –¥—É–±–ª—è)
- **Shop:** 2 + polling –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
- **Shelter:** 7 –∑–∞–ø—Ä–æ—Å–æ–≤
- **Marketplace:** 5 –∑–∞–ø—Ä–æ—Å–æ–≤
- **Dungeon battle (10 —É—Ä–æ–≤–Ω–µ–π):** 80-120 –∑–∞–ø—Ä–æ—Å–æ–≤
- **Team:** 4 –∑–∞–ø—Ä–æ—Å–∞

**–í–°–ï–ì–û:** ~112-135 –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ —Ç–∏–ø–∏—á–Ω—É—é –∏–≥—Ä–æ–≤—É—é —Å–µ—Å—Å–∏—é

### –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
- **–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:** 5 –∑–∞–ø—Ä–æ—Å–æ–≤ (-44%)
- **Equipment:** 1 –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å (-80%)
- **Shop:** 1 –∑–∞–ø—Ä–æ—Å, real-time –≤–º–µ—Å—Ç–æ polling (-100% polling)
- **Shelter:** 4 –∑–∞–ø—Ä–æ—Å–∞ (-43%)
- **Marketplace:** 2 –∑–∞–ø—Ä–æ—Å–∞ (—Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π)
- **Dungeon battle (10 —É—Ä–æ–≤–Ω–µ–π):** 1 –∑–∞–ø—Ä–æ—Å (-99%)
- **Team:** 1 –∑–∞–ø—Ä–æ—Å –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏

**–í–°–ï–ì–û:** ~30-40 –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ —Ç–∏–ø–∏—á–Ω—É—é –∏–≥—Ä–æ–≤—É—é —Å–µ—Å—Å–∏—é

### üéâ –†–ï–ó–£–õ–¨–¢–ê–¢: **60-70% –°–û–ö–†–ê–©–ï–ù–ò–ï –ó–ê–ü–†–û–°–û–í**

---

## ‚úÖ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

1. **–°–æ–≥–ª–∞—Å–æ–≤–∞—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã** —Å –∫–æ–º–∞–Ω–¥–æ–π
2. **–°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏** –¥–ª—è –Ω–æ–≤—ã—Ö RPC —Ñ—É–Ω–∫—Ü–∏–π
3. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏** (–ø—É–Ω–∫—Ç—ã 1-4)
4. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** –Ω–∞ dev –æ–∫—Ä—É–∂–µ–Ω–∏–∏
5. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –º–µ—Ç—Ä–∏–∫** –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è
6. **–ò—Ç–µ—Ä–∞—Ü–∏—è** –ø–æ —Å—Ä–µ–¥–Ω–∏–º –∏ –Ω–∏–∑–∫–∏–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º

---

**–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** 2025-11-23  
**–ê–≤—Ç–æ—Ä:** AI Assistant  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏