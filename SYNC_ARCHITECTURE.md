# Архитектура синхронизации данных

## Принцип работы

Все игровые данные теперь хранятся **только в Supabase**. LocalStorage больше НЕ используется для персистентности игровых данных.

## Поток данных

```
Supabase (источник истины)
    ↓
useGameData → загружает данные из Supabase
    ↓
useGameSync → синхронизирует с Zustand store
    ↓
Zustand Store (временное состояние в памяти)
    ↓
React Components (UI)
    ↓
Изменения через actions
    ↓
useGameSync → автоматически синхронизирует обратно в Supabase
```

## Ключевые компоненты

### 1. **gameStore.ts**
- Zustand store БЕЗ persist middleware
- Все данные в памяти (не сохраняются в localStorage)
- Содержит actions для изменения состояния

### 2. **useGameSync.ts**
- Загружает данные из Supabase в Zustand при подключении кошелька
- Автоматически синхронизирует изменения обратно в Supabase
- Очищает store при смене/отключении кошелька
- Удаляет старые localStorage ключи при монтировании

### 3. **useGameData.ts**
- Загружает данные из Supabase по wallet address
- Использует deduplicated loader для предотвращения дублирующих запросов
- Предоставляет методы для обновления данных

### 4. **WalletConnectContext.tsx**
- Управляет подключением NEAR кошелька
- Сохраняет только `walletConnected` и `walletAccountId` в localStorage
- При отключении очищает ВСЕ игровые данные из localStorage

## Очищенные localStorage ключи

При загрузке приложения автоматически удаляются:
- `game-storage` (старый persist store)
- `gameCards`
- `gameBalance`
- `gameInventory`
- `gameDragonEggs`
- `gameSelectedTeam`
- `game_balance`
- `game_cards`
- `game_inventory`
- `game_dragonEggs`
- `game_selectedTeam`
- `game_accountLevel`
- `game_accountExperience`

## Преимущества новой архитектуры

✅ **Единый источник истины** - данные всегда в Supabase
✅ **Кросс-девайс синхронизация** - одинаковые данные на всех устройствах
✅ **Нет рассинхронизации** - localStorage больше не конфликтует с сервером
✅ **Автоматическая очистка** - при смене кошелька данные полностью очищаются
✅ **Надежность** - нет риска потери данных из-за очистки браузера

## Миграция для пользователей

При первой загрузке после обновления:
1. Старые localStorage данные автоматически удаляются
2. Загружаются актуальные данные из Supabase
3. Если пользователь входит с другого устройства - видит те же данные

## Важные замечания

⚠️ **НЕ ИСПОЛЬЗОВАТЬ** `persist` middleware в Zustand для игровых данных
⚠️ **НЕ СОХРАНЯТЬ** игровые данные в localStorage напрямую
⚠️ **ВСЕГДА** использовать actions из gameStore для изменения данных
⚠️ **ДОВЕРЯТЬ** только данным из Supabase как источнику истины
