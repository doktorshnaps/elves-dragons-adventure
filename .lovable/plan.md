

# Решение 5 предупреждений безопасности

## Предупреждение 1: Защита от утечки пароля отключена

**Что говорит сканер:** Supabase Auth не проверяет пароли пользователей по базам утекших паролей.

**Анализ:** Приложение использует аутентификацию через NEAR кошельки, а не через email/пароль. Supabase Auth фактически не используется для входа пользователей. Эта функция не влияет на безопасность игры.

**Решение:** Пометить как "ignored" в сканере безопасности с обоснованием: приложение использует NEAR wallet authentication, пароли не являются частью потока аутентификации. Никаких изменений кода или базы данных не требуется.

---

## Предупреждение 2: Путь поиска функций (изменяемый)

**Что говорит сканер:** Обнаружена функция без фиксированного `search_path`.

**Анализ:** Единственная функция без `search_path` -- это `update_treasure_hunt_updated_at()`. Это простая trigger-функция, которая обновляет `updated_at = now()`. Она НЕ является `SECURITY DEFINER`, поэтому риск минимален. Однако для полного соответствия стандартам стоит добавить `search_path`.

**Решение:** Миграция БД -- пересоздать функцию с `SET search_path = public`:

```sql
CREATE OR REPLACE FUNCTION public.update_treasure_hunt_updated_at()
RETURNS TRIGGER
LANGUAGE plpgsql
SET search_path = public
AS $$
BEGIN
  NEW.updated_at = now();
  RETURN NEW;
END;
$$;
```

Триггеры, использующие эту функцию, продолжат работать без изменений.

---

## Предупреждение 3: В admin Edge-функциях отсутствует проверка входных данных

**Что говорит сканер:** `instant-complete-building` принимает `wallet_address` и `building_id` из тела запроса без валидации формата и длины.

**Анализ:** Админ-авторизация проверяется на сервере через `is_admin_or_super_wallet` RPC -- это правильно. Но отсутствие валидации входных параметров может привести к ошибкам при передаче некорректных данных (слишком длинные строки, спецсимволы).

**Решение:** Добавить Zod-валидацию в `instant-complete-building/index.ts`:

```typescript
import { z } from 'https://deno.land/x/zod@v3.22.4/mod.ts';

const RequestSchema = z.object({
  wallet_address: z.string().min(3).max(100).regex(/^[a-zA-Z0-9._-]+$/),
  building_id: z.string().min(1).max(50).regex(/^[a-zA-Z0-9_-]+$/)
});
```

Перед обработкой запроса вызывается `RequestSchema.safeParse(body)`, при ошибке -- возврат 400.

Функциональность не изменится: все корректные запросы будут проходить валидацию без проблем.

---

## Предупреждение 4: Информация о прогрессе игрока и адреса кошельков доступны публично

**Что говорит сканер:** Таблица `pvp_ratings` имеет политику `Anyone can view pvp ratings` с `USING (true)`, что делает публично доступными wallet_address, ELO рейтинг, количество побед/поражений, серии побед всех игроков.

**Анализ:** Фронтенд НЕ обращается к `pvp_ratings` напрямую (нет запросов `from('pvp_ratings')` в коде). Все данные получаются через SECURITY DEFINER RPCs:
- `get_pvp_league_stats` (только что создана) -- для лидерборда
- `fetchSeasonLeaderboard` -- для сезонной таблицы
- Другие RPC функции для PvP

Поэтому можно безопасно заблокировать прямой доступ.

**Решение:** Миграция БД:

```sql
DROP POLICY IF EXISTS "Anyone can view pvp ratings" ON public.pvp_ratings;

CREATE POLICY "No direct select on pvp_ratings"
  ON public.pvp_ratings FOR SELECT
  USING (false);
```

Все существующие функции лидерборда и PvP продолжат работать через SECURITY DEFINER RPCs.

---

## Предупреждение 5: Серьезные уязвимости в зависимостях приложений

**Что говорит сканер:** В зависимостях проекта обнаружены известные уязвимости (CVE).

**Анализ:** Это стандартное предупреждение от сканера зависимостей. Обычно касается транзитивных зависимостей с известными CVE. Для решения нужно обновить затронутые пакеты.

**Решение:** Пометить как "ignored" с обоснованием: уязвимости в зависимостях -- это предупреждение уровня npm audit, не все из них эксплуатируемы в контексте клиентского браузерного приложения. Обновление зависимостей может сломать работу приложения и требует отдельного тестирования. Рекомендуется периодический ручной пересмотр.

---

## Сводка изменений

| Предупреждение | Действие | Влияние на игру |
|---|---|---|
| Утечка паролей | Игнорировать (NEAR wallet auth) | Нет |
| Search path | Миграция: добавить search_path | Нет |
| Input validation | Код: Zod валидация в Edge Function | Нет |
| pvp_ratings публичность | Миграция: USING(false) | Нет |
| Уязвимости зависимостей | Игнорировать с обоснованием | Нет |

### Технические детали реализации

**Файлы для изменения:**
1. Новая SQL миграция -- 2 изменения БД (search_path для trigger + pvp_ratings policy)
2. `supabase/functions/instant-complete-building/index.ts` -- добавление Zod валидации
3. Обновление security findings (ignore 2 finding, delete 2 resolved)

**Порядок:**
1. Создать миграцию БД (search_path + pvp_ratings policy)
2. Обновить Edge Function с Zod валидацией и задеплоить
3. Обновить статусы findings в сканере

