
# –ö–ª–∞–Ω–æ–≤—ã–µ –†–µ–π–¥-–ë–æ—Å—Å—ã ‚Äî –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

## –ö–æ–Ω—Ü–µ–ø—Ü–∏—è

–†–∞–∑ –≤ —Å—É—Ç–∫–∏ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –º–∏—Ä–æ–≤–æ–π —Ä–µ–π–¥-–±–æ—Å—Å. –£ –∫–∞–∂–¥–æ–≥–æ –∏–≥—Ä–æ–∫–∞ ‚Äî **–æ–¥–Ω–∞ –ø–æ–ø—ã—Ç–∫–∞ –∞—Ç–∞–∫–∏** –≤ —Ä–∞–º–∫–∞—Ö —Ä–µ–π–¥–∞. –ö–ª–∞–Ω —Å—É–º–º–∏—Ä—É–µ—Ç —É—Ä–æ–Ω –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤. –ü–æ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ –≤—Ä–µ–º–µ–Ω–∏ (4-8 —á–∞—Å–æ–≤) ‚Äî –µ—Å–ª–∏ –±–æ—Å—Å —É–±–∏—Ç, –∫–ª–∞–Ω —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º –Ω–∞–Ω–µ—Å—ë–Ω–Ω—ã–º —É—Ä–æ–Ω–æ–º –ø–æ–ª—É—á–∞–µ—Ç –≥–ª–∞–≤–Ω—ã–π –ø—Ä–∏–∑. –í—Å–µ –∫–ª–∞–Ω—ã, —É—á–∞—Å—Ç–≤–æ–≤–∞–≤—à–∏–µ –≤ —É–±–∏–π—Å—Ç–≤–µ, –ø–æ–ª—É—á–∞—é—Ç –Ω–∞–≥—Ä–∞–¥—ã –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ —É—Ä–æ–Ω—É.

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞: 4 —Å–ª–æ—è

### –°–ª–æ–π 1 ‚Äî –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (–Ω–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã)

**`clan_raid_events`** ‚Äî –∞–∫—Ç–∏–≤–Ω—ã–π/–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–π —Ä–µ–π–¥-–±–æ—Å—Å:
```text
id             uuid PK
boss_name      text          -- "–î—Ä–∞–∫–æ–Ω –•–∞–æ—Å–∞", "–¢—ë–º–Ω—ã–π –õ–∏—á"
boss_image     text          -- URL –∫–∞—Ä—Ç–∏–Ω–∫–∏
total_hp       bigint        -- –Ω–∞–ø—Ä–∏–º–µ—Ä 100_000_000
current_hp     bigint        -- —É–±—ã–≤–∞–µ—Ç –ø–æ –º–µ—Ä–µ –∞—Ç–∞–∫
max_hp         bigint        -- –¥–ª—è –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
status         text          -- 'active' | 'defeated' | 'expired'
started_at     timestamptz
ends_at        timestamptz   -- started_at + 8 —á–∞—Å–æ–≤
rewards_distributed boolean DEFAULT false
winner_clan_id uuid FK clans
created_by     text          -- admin wallet
```

**`clan_raid_attacks`** ‚Äî –∫–∞–∂–¥–∞—è –∞—Ç–∞–∫–∞ –∏–≥—Ä–æ–∫–∞ –ø–æ –±–æ—Å—Å—É:
```text
id             uuid PK
raid_event_id  uuid FK clan_raid_events
wallet_address text          -- –∫—Ç–æ –∞—Ç–∞–∫–æ–≤–∞–ª
clan_id        uuid FK clans -- –∫–ª–∞–Ω –≤ –º–æ–º–µ–Ω—Ç –∞—Ç–∞–∫–∏
damage_dealt   bigint        -- –Ω–∞–Ω–µ—Å—ë–Ω–Ω—ã–π —É—Ä–æ–Ω
team_snapshot  jsonb         -- —Å–Ω–∏–º–æ–∫ –∫–æ–º–∞–Ω–¥—ã (–¥–ª—è —á–µ—Å—Ç–Ω–æ—Å—Ç–∏)
attacked_at    timestamptz
```
–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å: `(raid_event_id, wallet_address)` ‚Äî –æ–¥–Ω–∞ –ø–æ–ø—ã—Ç–∫–∞ –Ω–∞ –∏–≥—Ä–æ–∫–∞.

**`clan_raid_rankings`** ‚Äî –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —É—Ä–æ–Ω –ø–æ –∫–ª–∞–Ω–∞–º (–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Ç—Ä–∏–≥–≥–µ—Ä–æ–º):
```text
raid_event_id  uuid FK
clan_id        uuid FK clans
total_damage   bigint
members_participated integer
rank           integer       -- –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –ø—Ä–∏ —Ä–∞–∑–¥–∞—á–µ –Ω–∞–≥—Ä–∞–¥
```

---

### –°–ª–æ–π 2 ‚Äî Edge Functions (–±—ç–∫–µ–Ω–¥ –ª–æ–≥–∏–∫–∞)

**`clan-raid-attack`** ‚Äî –æ—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∞—Ç–∞–∫–∏:
1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç: —Ä–µ–π–¥ –∞–∫—Ç–∏–≤–µ–Ω, –Ω–µ –∏—Å—Ç—ë–∫, –∏–≥—Ä–æ–∫ –µ—â—ë –Ω–µ –∞—Ç–∞–∫–æ–≤–∞–ª
2. –ë–µ—Ä—ë—Ç –∫–æ–º–∞–Ω–¥—É –∏–≥—Ä–æ–∫–∞ –∏–∑ `player_teams`
3. –í—ã—á–∏—Å–ª—è–µ—Ç —É—Ä–æ–Ω: —Å—É–º–º–∞ power + magic –≤—Å–µ–π –∫–æ–º–∞–Ω–¥—ã √ó –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã (–∫–∞–∫ –≤ PvP)
4. –ê—Ç–æ–º–∞—Ä–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç `clan_raid_events.current_hp -= damage`
5. –í—Å—Ç–∞–≤–ª—è–µ—Ç –∑–∞–ø–∏—Å—å –≤ `clan_raid_attacks`
6. Upsert –≤ `clan_raid_rankings` (clan_id, += damage)
7. –ï—Å–ª–∏ `current_hp <= 0`: —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `status = 'defeated'`
8. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: –Ω–∞–Ω–µ—Å—ë–Ω–Ω—ã–π —É—Ä–æ–Ω, —Ç–µ–∫—É—â–∏–π HP –±–æ—Å—Å–∞, —Ä–∞–Ω–≥ –∫–ª–∞–Ω–∞

**`clan-raid-distribute-rewards`** ‚Äî –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ cron-–¥–∂–æ–±–æ–º –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ä–µ–π–¥–∞:
1. –ù–∞—Ö–æ–¥–∏—Ç –≤—Å–µ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ —Ä–µ–π–¥—ã –≥–¥–µ `rewards_distributed = false`
2. –°–æ—Ä—Ç–∏—Ä—É–µ—Ç –∫–ª–∞–Ω—ã –ø–æ total_damage
3. –†–∞–∑–¥–∞—ë—Ç ELL —á–µ—Ä–µ–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π `apply_battle_rewards` –º–µ—Ö–∞–Ω–∏–∑–º:
   - –ö–ª–∞–Ω #1 (winner): 500 ELL √ó —á–∏—Å–ª–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
   - –ö–ª–∞–Ω #2-3: 200 ELL √ó —á–∏—Å–ª–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
   - –í—Å–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ —É–±–∏–π—Å—Ç–≤–∞: 50 ELL –±–∞–∑–æ–≤–æ
4. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `rewards_distributed = true`

---

### –°–ª–æ–π 3 ‚Äî Frontend –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

**–ù–æ–≤–∞—è –≤–∫–ª–∞–¥–∫–∞ –≤ –ö–ª–∞–Ω–∞—Ö** ‚Äî `ClanRaidTab.tsx`:
```text
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  [–ö–∞—Ä—Ç–∏–Ω–∫–∞ –±–æ—Å—Å–∞]  –î—Ä–∞–∫–æ–Ω –•–∞–æ—Å–∞     ‚îÇ
‚îÇ  HP: ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë  78,432,100 / 100M‚îÇ
‚îÇ  –û—Å—Ç–∞–ª–æ—Å—å: 05:32:17                 ‚îÇ
‚îÇ  –°—Ç–∞—Ç—É—Å: –ê–ö–¢–ò–í–ï–ù                    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  [–ê–¢–ê–ö–û–í–ê–¢–¨ –ë–û–°–°–ê]  ‚Üê –∫–Ω–æ–ø–∫–∞        ‚îÇ
‚îÇ  –í–∞—à —É—Ä–æ–Ω: 4,200 (—É–∂–µ –∞—Ç–∞–∫–æ–≤–∞–ª–∏)    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  –†–µ–π—Ç–∏–Ω–≥ –∫–ª–∞–Ω–æ–≤:                    ‚îÇ
‚îÇ  ü•á –ù–∞–≥–∏–±–∞—Ç–æ—Ä—ã  ‚Äî 12,400,000        ‚îÇ
‚îÇ  ü•à –ú—É—Å–æ—Ä—â–∏–∫–∏   ‚Äî 8,900,000         ‚îÇ
‚îÇ  ü•â test        ‚Äî 2,100,000         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**`RaidBossCard.tsx`** ‚Äî –∫–∞—Ä—Ç–æ—á–∫–∞ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π –∞—Ç–∞–∫–∏ (–∫–∞–∫ –≤ AdventureGame).

**`useRaidBoss.ts`** ‚Äî —Ö—É–∫:
- –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–π–¥ —á–µ—Ä–µ–∑ React Query (refetch –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫)
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç: –∞—Ç–∞–∫–æ–≤–∞–ª –ª–∏ —Ç–µ–∫—É—â–∏–π –∏–≥—Ä–æ–∫
- –í—ã–∑—ã–≤–∞–µ—Ç `clan-raid-attack` Edge Function

---

### –°–ª–æ–π 4 ‚Äî Cron Job (–∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è)

–ö–∞–∂–¥—ã–µ 15 –º–∏–Ω—É—Ç cron –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–µ–π–¥—ã:
```sql
SELECT net.http_post(
  url := 'https://[project].supabase.co/functions/v1/clan-raid-distribute-rewards',
  ...
) WHERE EXISTS (
  SELECT 1 FROM clan_raid_events 
  WHERE status = 'active' AND ends_at < now()
);
```

–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤–æ–≥–æ –±–æ—Å—Å–∞ –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é Admin –ø–∞–Ω–µ–ª—å.

---

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å —É—Ä–æ–Ω–∞

–£—Ä–æ–Ω –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è **–Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ** –≤ Edge Function ‚Äî –ø–æ —Ç–æ–º—É –∂–µ –ø—Ä–∏–Ω—Ü–∏–ø—É, —á—Ç–æ `claim-battle-rewards`:
- –ë–µ—Ä—ë—Ç –∫–∞—Ä—Ç—ã –∏–≥—Ä–æ–∫–∞ –∏–∑ `card_instances` (–Ω–µ–ª—å–∑—è –ø–æ–¥–º–µ–Ω–∏—Ç—å)
- –ü—Ä–∏–º–µ–Ω—è–µ—Ç —Ñ–æ—Ä–º—É–ª—É: `total_power = SUM(hero.power + dragon.magic) √ó rarity_bonus`
- –ö–ª–∏–µ–Ω—Ç —Ç–æ–ª—å–∫–æ –≤—ã–∑—ã–≤–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é, –Ω–µ –ø–µ—Ä–µ–¥–∞—ë—Ç —Å—É–º–º—É —É—Ä–æ–Ω–∞

### –ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å HP –±–æ—Å—Å–∞

–ß—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å race condition –ø—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∞—Ç–∞–∫–∞—Ö:
```sql
UPDATE clan_raid_events 
SET current_hp = GREATEST(0, current_hp - p_damage)
WHERE id = p_raid_id AND status = 'active'
RETURNING current_hp;
```
PostgreSQL –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å —ç—Ç–æ–≥–æ UPDATE.

### –†–µ–∞–ª—Ç–∞–π–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ

Supabase Realtime –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ `clan_raid_events` ‚Äî –≤—Å–µ –∏–≥—Ä–æ–∫–∏ –≤–∏–¥—è—Ç —É–±—ã–≤–∞—é—â–∏–π HP –±–æ—Å—Å–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.

---

## –ß—Ç–æ –Ω–æ–≤–æ–≥–æ —Å–æ–∑–¥–∞—ë–º

| –ß—Ç–æ | –¢–∏–ø | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|-----|-----|-------------|
| `clan_raid_events` | –¢–∞–±–ª–∏—Ü–∞ | –ë–æ—Å—Å—ã |
| `clan_raid_attacks` | –¢–∞–±–ª–∏—Ü–∞ | –ê—Ç–∞–∫–∏ –∏–≥—Ä–æ–∫–æ–≤ |
| `clan_raid_rankings` | –¢–∞–±–ª–∏—Ü–∞ | –ê–≥—Ä–µ–≥–∞—Ü–∏—è –ø–æ –∫–ª–∞–Ω–∞–º |
| `clan-raid-attack` | Edge Function | –õ–æ–≥–∏–∫–∞ –∞—Ç–∞–∫–∏ |
| `clan-raid-distribute-rewards` | Edge Function | –†–∞–∑–¥–∞—á–∞ –Ω–∞–≥—Ä–∞–¥ |
| Cron job | SQL | –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ —Ä–∞–∑–¥–∞—á–∏ |
| `ClanRaidTab.tsx` | –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | UI –≤–∫–ª–∞–¥–∫–∏ —Ä–µ–π–¥–∞ |
| `RaidBossCard.tsx` | –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –ö–∞—Ä—Ç–æ—á–∫–∞ –±–æ—Å—Å–∞ |
| `useRaidBoss.ts` | –•—É–∫ | –î–∞–Ω–Ω—ã–µ + –∞—Ç–∞–∫–∞ |
| –ö–Ω–æ–ø–∫–∞ –∑–∞–ø—É—Å–∫–∞ –±–æ—Å—Å–∞ | Admin –ø–∞–Ω–µ–ª—å | –î–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ |

---

## –ß—Ç–æ –ù–ï –Ω—É–∂–Ω–æ –º–µ–Ω—è—Ç—å

- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–∞–±–ª–∏—Ü—ã `clans`, `clan_members` ‚Äî —Ç–æ–ª—å–∫–æ —á–∏—Ç–∞–µ–º
- –ë–æ–µ–≤–∞—è –º–µ—Ö–∞–Ω–∏–∫–∞ PvP ‚Äî –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–æ—Ä–º—É–ª—ã —É—Ä–æ–Ω–∞
- –°–∏—Å—Ç–µ–º–∞ `reward_claims` ‚Äî –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–ª—è –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –Ω–∞–≥—Ä–∞–¥
- `apply_battle_rewards` RPC ‚Äî –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–ª—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è ELL

---

## –ü–æ—Ä—è–¥–æ–∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ (5 —ç—Ç–∞–ø–æ–≤)

1. **–ú–∏–≥—Ä–∞—Ü–∏—è –ë–î** ‚Äî 3 –Ω–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã + RLS –ø–æ–ª–∏—Ç–∏–∫–∏
2. **Edge Function `clan-raid-attack`** ‚Äî –ª–æ–≥–∏–∫–∞ –∞—Ç–∞–∫–∏ + —Ä–∞—Å—á—ë—Ç —É—Ä–æ–Ω–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
3. **Edge Function `clan-raid-distribute-rewards`** + cron
4. **Frontend** ‚Äî `useRaidBoss`, `ClanRaidTab`, `RaidBossCard`
5. **Admin UI** ‚Äî –∫–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –±–æ—Å—Å–∞ —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π HP/–≤—Ä–µ–º–µ–Ω–∏/–Ω–∞–≥—Ä–∞–¥
